# MongoDB 4.0的发布说明



### 多文件交易

从4.0版本开始，MongoDB提供了对副本集执行[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)的能力。对于多文档事务，在事务提交之前，事务中不会在事务之外看到写入操作。也就是说，多文档交易是原子的。

> 重要：
>
> 在大多数情况下，多文档事务比单文档写入带来更高的性能成本，多文档事务的可用性不应成为有效模式设计所取代的场所。在许多情况下，[去规范化数据模型（嵌入式文档和数组）](https://www.mongodb.com/docs/upcoming/core/data-model-design/#std-label-data-modeling-embedding)将继续最适合您的数据和用例。也就是说，对于许多场景，适当建模您的数据将最大限度地减少对多文档交易的需求。
>
> 有关其他事务使用注意事项（如运行时限制和oplog大小限制），另请参阅[生产注意事项。](https://www.mongodb.com/docs/upcoming/core/transactions-production-consideration/#std-label-production-considerations)

#### 功能兼容性

副本集所有成员`featureCompatibilityVersion`必须为`4.0`或更高。要检查成员`featureCompatibilityVersion`，请连接到成员并运行以下命令：

```
db.adminCommand( { getParameter: 1, featureCompatibilityVersion: 1 } )
```

有关 `featureCompatibilityVersion`标志的更多信息，请参阅see[`setFeatureCompatibilityVersion`。](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#mongodb-dbcommand-dbcmd.setFeatureCompatibilityVersion)

#### `mongo`shell方法

| 方法                                                         | 描述             |
| :----------------------------------------------------------- | :--------------- |
| [`Session.startTransaction()`](https://www.mongodb.com/docs/upcoming/reference/method/Session.startTransaction/#mongodb-method-Session.startTransaction) | 启动多陈述事务。 |
| [`Session.commitTransaction()`](https://www.mongodb.com/docs/upcoming/reference/method/Session.commitTransaction/#mongodb-method-Session.commitTransaction) | 提交交易。       |
| [`Session.abortTransaction()`](https://www.mongodb.com/docs/upcoming/reference/method/Session.abortTransaction/#mongodb-method-Session.abortTransaction) | 中止交易。       |

#### MongoDB驱动程序

客户需要MongoDB驱动程序[为MongoDB 4.0更新](https://www.mongodb.com/docs/upcoming/release-notes/4.0/#std-label-4.0-drivers)使用交易。

#### 阅读关注`snapshot`

MongoDB 4.0为[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/)引入了新的读取关注级别[`"snapshot"`](https://www.mongodb.com/docs/upcoming/reference/read-concern-snapshot/#mongodb-readconcern-readconcern.-snapshot-)[”。](https://www.mongodb.com/docs/upcoming/core/transactions/)

对于[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)，MongoDB有时可能会用更强的读取关注来代替[`"local"`](https://www.mongodb.com/docs/upcoming/reference/read-concern-local/#mongodb-readconcern-readconcern.-local-)和[`"majority"`](https://www.mongodb.com/docs/upcoming/reference/read-concern-majority/#mongodb-readconcern-readconcern.-majority-)读取关注。

有关所有接受读取顾虑的操作的列表，请参阅[支持读取关注的操作。](https://www.mongodb.com/docs/upcoming/reference/read-concern/#std-label-read-concern-operations)

#### 阅读偏好

包含读取操作的[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)必须使用读取首选项[`primary`](https://www.mongodb.com/docs/upcoming/core/read-preference/#mongodb-readmode-primary)。给定事务中的所有操作都必须路由到同一成员。

#### 命令

- [`abortTransaction`](https://www.mongodb.com/docs/upcoming/reference/command/abortTransaction/#mongodb-dbcommand-dbcmd.abortTransaction)

  Use the corresponding driver method or `mongo` shell helper [`Session.abortTransaction()`](https://www.mongodb.com/docs/upcoming/reference/method/Session.abortTransaction/#mongodb-method-Session.abortTransaction) instead.

- [`commitTransaction`](https://www.mongodb.com/docs/upcoming/reference/command/commitTransaction/#mongodb-dbcommand-dbcmd.commitTransaction)

  Use the corresponding driver method or `mongo` shell helper [`Session.commitTransaction()`](https://www.mongodb.com/docs/upcoming/reference/method/Session.commitTransaction/#mongodb-method-Session.commitTransaction) instead.

#### 锁

默认情况下，[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)等待`5`毫秒才能获得事务中操作所需的锁。如果事务无法在`5`毫秒内获得所需的锁，则交易将中止。

您可以使用[`maxTransactionLockRequestTimeoutMillis`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.maxTransactionLockRequestTimeoutMillis)参数来调整交易等待获取锁的时间。

事务在中止或提交时释放所有锁。

#### `$currentOp`

聚合管道阶段 [`$currentOp`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-pipeline-pipe.-currentOp) (以及 [`currentOp`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-dbcommand-dbcmd.currentOp)命令 和 `mongo` shell 助手 [`db.currentOp()`](https://www.mongodb.com/docs/upcoming/reference/method/db.currentOp/#mongodb-method-db.currentOp) 方法) 返回关于作为事务一部分有锁的非活动会话的消息

#### 参数

- [`transactionLifetimeLimitSeconds`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.transactionLifetimeLimitSeconds)指定[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)的生命周期，之后事务被视为已过期，并将在下一次运行定期清理过程时中止。
- [`maxTransactionLockRequestTimeoutMillis`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.maxTransactionLockRequestTimeoutMillis)指定[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)应该等待多长时间才能获得事务中操作所需的锁。

### 集合

#### 新型转换运算符

MongoDB 4.0为类型转换添加了以下新的聚合运算符：

| 运算符号                                                     | 描述                         |
| :----------------------------------------------------------- | :--------------------------- |
| [`$convert`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/convert/#mongodb-expression-exp.-convert) | 将值转换为指定类型。         |
| [`$toBool`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toBool/#mongodb-expression-exp.-toBool) | 将值转换为布尔值。           |
| [`$toDate`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toDate/#mongodb-expression-exp.-toDate) | 将值转换为日期。             |
| [`$toDecimal`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toDecimal/#mongodb-expression-exp.-toDecimal) | 货币转换器 值为 Decimal128。 |
| [`$toDouble`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toDouble/#mongodb-expression-exp.-toDouble) | 将值转换为Double。           |
| [`$toInt`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toInt/#mongodb-expression-exp.-toInt) | 将值转换为整数。             |
| [`$toLong`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toLong/#mongodb-expression-exp.-toLong) | 将值转换为长。               |
| [`$toObjectId`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toObjectId/#mongodb-expression-exp.-toObjectId) | 将值转换为ObjectId。         |
| [`$toString`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/toString/#mongodb-expression-exp.-toString) | 将值转换为字符串。           |

#### 新的字符串运算符

MongoDB 4.0添加了以下新的聚合字符串运算符：

| 运算符号                                                     | 描述                                     |
| :----------------------------------------------------------- | :--------------------------------------- |
| [`$ltrim`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/ltrim/#mongodb-expression-exp.-ltrim) | 从字符串开头删除空格或指定字符。         |
| [`$rtrim`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/rtrim/#mongodb-expression-exp.-rtrim) | 从设置末尾删除空格或指定字符。           |
| [`$trim`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/trim/#mongodb-expression-exp.-trim) | 从字符串的开头和结尾删除空格或指定字符。 |

#### 其他改进

##### `$bucket`

[`$bucket`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/bucket/#mongodb-pipeline-pipe.-bucket)阶段不再要求`boundaries`文档参数用[`$literal`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/literal/#mongodb-expression-exp.-literal)包装[。](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/literal/#mongodb-expression-exp.-literal)

##### `$dateToString`

[`$dateToString`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/dateToString/#mongodb-expression-exp.-dateToString)聚合运算符具有以下选项更改：

> 笔记：
>
> Requires `featureCompatibilityVersion` (fcv) set to `"4.0"`or greater.

- 一个新的 `onNull` 选择指定了在 `date` 为空或缺失时返回的值。
- 选项`format`现在是可选的。

##### `$dateFromParts`

如果为`year`、`isoYear`和`timezone`以外的字段指定的值超出有效范围，[`$dateFromParts`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/dateFromParts/#mongodb-expression-exp.-dateFromParts)携带或减去其他日期部分的差额来计算日期。有关更多信息，请参阅[值范围。](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/dateFromParts/#std-label-dateFromParts-values)

##### `$dateFromString`

[`$dateFromString`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/dateFromString/#mongodb-expression-exp.-dateFromString)聚合运算符采用可选`format`字段。

##### `$currentOp`

聚合管道阶段[`$currentOp`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-pipeline-pipe.-currentOp)支持以下新选项：

- `idleSessions`选项返回作为事务的一部分持有锁的不活动会话的信息。
- `localOps`选项是报告在当前[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)实例上本地运行的操作，而不是报告在碎片上运行的操作。

### MongoDB驱动程序

以下驱动程序的功能与MongoDB 4.0兼容：

|              |           |                  |
| ------------ | --------- | ---------------- |
| Java 3.8.0   | C# 2.7    | Perl 2.0.0       |
| Python 3.7.0 | Node3.1.0 | PHP（PHPC）1.5.0 |
| C 1.11.0     | Ruby2.6.0 | cala 2.4.0       |

### 安全

#### 添加支持`SCRAM-SHA-256`

>笔记：
>
>要使用[SCRAM-SHA-256](https://www.mongodb.com/docs/upcoming/core/security-scram/#std-label-authentication-scram-sha-256)，`featureCompatibilityVersion`必须设置为`4.0`。有关 featureCompatibilityVersion的更多信息，请参阅[Get FeatureCompatibilityVersion](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)和[`setFeatureCompatibilityVersion`。](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#mongodb-dbcommand-dbcmd.setFeatureCompatibilityVersion)

MongoDB增加了对[SCRAM](https://www.mongodb.com/docs/upcoming/core/security-scram/#std-label-authentication-scram)身份验证机制[SCRAM-SHA-256](https://www.mongodb.com/docs/upcoming/core/security-scram/#std-label-scram-mechanisms)的支持，该机制使用SHA-256哈希函数。为了修改`SCRAM-SHA-256`的迭代计数，MongoDB添加了一个新的参数[`scramSHA256IterationCount`。](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.scramSHA256IterationCount)

##### 创建和更新用户操作的新选项

当创建或更新一个scram用户时，您可以指定用于用户凭证的特定scram机制。具体来说， MongoDB 4.0 在以下命令和mongo shell helper中添加了`mechanisms`选项

| 指挥权                                                       | 方法                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`createUser`](https://www.mongodb.com/docs/upcoming/reference/command/createUser/#mongodb-dbcommand-dbcmd.createUser) | [`db.createUser()`](https://www.mongodb.com/docs/upcoming/reference/method/db.createUser/#mongodb-method-db.createUser) |
| [`updateUser`](https://www.mongodb.com/docs/upcoming/reference/command/updateUser/#mongodb-dbcommand-dbcmd.updateUser) | [`db.updateUser()`](https://www.mongodb.com/docs/upcoming/reference/method/db.updateUser/#mongodb-method-db.updateUser) |

使用`SCRAM-SHA-256`时，MongoDB（即服务器）需要解锁密码。从MongoDB 4.0开始，`digestPassword`的默认值对[`createUser`](https://www.mongodb.com/docs/upcoming/reference/command/createUser/#mongodb-dbcommand-dbcmd.createUser)为`true`，`passwordDigestor`的默认值为`"server"`在早期的MongoDB版本中，`digestPassword`分别是`false`和`client`。

##### `isMaster`命令的新选项

从MongoDB 4.0开始，`isMaster`命令接受可选字段`saslSupportedMechs: <db.user>`在其结果中返回额外的fieldisMaster`isMaster.saslSupportedMechs`。

`isMaster.saslSupportedMechs`是用于创建指定用户凭据的SASL机制数组。

##### 移除对`MONGODB-CR`

从4.0版本开始，MongoDB取消了对已弃用的MongoDB挑战响应（`MONGODB-CR`）身份验证机制的支持。

自3.0版本以来，MongoDB不支持创建`MONGODB-CR`用户，除非部署已从2.6或更早的部署升级，该部署已经拥有`MONGODB-CR`用户，并且尚未升级身份验证模式。

如果您的部署在`MONGODB-CR`模式中存储了用户凭据，则在升级到4.0版本**之前**，您必须升级到[咸味挑战响应身份验证机制（SCRAM](https://www.mongodb.com/docs/upcoming/core/security-scram/#std-label-authentication-scram)）。有关升级到`SCRAM`的信息，请参阅[升级到SCRAM。](https://www.mongodb.com/docs/upcoming/release-notes/3.0-scram/)

#### `usersInfo`增强

[`usersInfo`](https://www.mongodb.com/docs/upcoming/reference/command/usersInfo/#mongodb-dbcommand-dbcmd.usersInfo)命令可以通过指定以下方式返回所有数据库的信息：

```
{ usersInfo: { forAllDBs: true } }
```

 [`usersInfo`](https://www.mongodb.com/docs/upcoming/reference/command/usersInfo/#mongodb-dbcommand-dbcmd.usersInfo) 和 `mongo` shell 辅助程序 [`db.getUser()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getUser/#mongodb-method-db.getUser) 和 [`db.getUsers()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getUsers/#mongodb-method-db.getUsers)  方法接受一个新的可选过滤器文档`filter` 文档指定[`$match`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match) 阶段条件，以便仅为匹配条件的用户返回信息 。

 [`usersInfo`](https://www.mongodb.com/docs/upcoming/reference/command/usersInfo/#mongodb-dbcommand-dbcmd.usersInfo) 命令和 mongo shell helpers.[`db.getUser()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getUser/#mongodb-method-db.getUser) 和[`db.getUsers()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getUsers/#mongodb-method-db.getUsers)方法返回用户的机制字段。

| 平台      | TLS/SSL库            |
| :-------- | :------------------- |
| 窗口      | 安全通道（Schannel） |
| Linux/BSD | OpenSSL              |
| macOS     | 安全运输             |

与此更改相关联，Linux/BSD支持参数[`opensslCipherConfig`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.opensslCipherConfig)，Windows和macOS不再支持该参数。

##### TLS 1.2支持

适用于macOS的MongoDB 4.0二进制文件支持TLS 1.2。

##### 禁用TLS 1.0

MongoDB二进制文件（[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)、[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)和`mongo`）在提供TLS 1.1+的系统上禁用对TLS 1.0加密的支持。

如果您需要支持TLS 1.0：

- 对于[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)实例，您可以指定`none`tonet[`net.ssl.disabledProtocols`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.disabledProtocols)或[`--sslDisabledProtocols none`。](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--sslDisabledProtocols)

- 对于[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)实例，您可以指定`none`tonet[`net.ssl.disabledProtocols`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.disabledProtocols)或[`--sslDisabledProtocols none`。](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#std-option-mongos.--sslDisabledProtocols)

- For the `mongo` shell, you can specify`--sslDisabledProtocols none`.

  `--sslDisabledProtocols`选项适用于`mongo`壳：

  - MongoDB 4.0+版本
  - MongoDB 3.6.5版本+
  - MongoDB版本3.4.15+

在 macOS 上，将`mongo` shell 版本 3.6.4 或更早版本连接到 MongoDB 4.0+ 部署需要显示启用TLS1.0

#### AES-GC

Windows上的MongoDB Enterprise不再支持`AES256-GCM`。此密码现在仅在Linux上可用。

>另见：
>
>[在Windows和macOS上为TLS/SSL启用系统存储](https://www.mongodb.com/docs/upcoming/release-notes/4.0/#std-label-4.0-ssl-systemstore)

##### 新的特权行动

支持[免费云监控](https://www.mongodb.com/docs/upcoming/release-notes/4.0/#std-label-4.0-free-monitoring)，MongoDB为`cluster`资源添加了以下特权操作：

- [`checkFreeMonitoringStatus`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-checkFreeMonitoringStatus)
- [`setFreeMonitoring`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-setFreeMonitoring)

MongoDB修改了[`clusterMonitor`](https://www.mongodb.com/docs/upcoming/reference/built-in-roles/#mongodb-authrole-clusterMonitor)角色以包含这些特权。

##### x.509 认证证书限制

从MongoDB 4.2, 开始，如果指定`--tlsAllowInvalidateCertificates` 或``net.tls.allowInvalidCertificates: true`在使用x.509身份验证时，无效证书只够建立tls连接，而不足以进行身份验证。

如果您使用无效证书执行x.509身份验证，请将证书更新为有效证书。例如，您可以使用受信任的CA对现有证书进行签名，或者如果使用自定义CA，请使用[`net.ssl.CAFile`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.CAFile)指定该CA[。](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.CAFile)

##### 在Windows和macOS上为TLS/SSL启用系统存储

 [`--sslCertificateSelector`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--sslCertificateSelector) 选项 ([`certificateSelector`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.certificateSelector)设置) 允许 [`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)、`mongo` shell 和[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos) 使用Windows 和 macOS的系统SSL证书存储。

[`--sslClusterCertificateSelector`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--sslClusterCertificateSelector)选项（[`clusterCertificateSelector`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.clusterCertificateSelector)设置）允许[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)和[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)使用Windows和macOS的系统TLS/SSL证书存储进行集群内的内部TLS/SSL通信。

选项[`--kmipClientCertificateSelector`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--kmipClientCertificateSelector)（[`security.kmip.clientCertificateSelector`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-security.kmip.clientCertificateSelector)）允许[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)在使用TLS/SSL连接到KMIP服务器时使用Windows和macOS的系统TLS/SSL证书存储。

### 不建议使用MMAPv1

从4.0版本开始，MongoDB不建议使用MMAPv1存储引擎，并将在未来的版本中删除MMAPv1。

要将您的MMAPv1存储引擎部署更改为[WiredTiger存储引擎](https://www.mongodb.com/docs/upcoming/core/wiredtiger/)，请参阅：

- [将“独立产品”更改为“WiredTiger”](https://www.mongodb.com/docs/upcoming/tutorial/change-standalone-wiredtiger/)
- [将副本集更改为WiredTiger](https://www.mongodb.com/docs/upcoming/tutorial/change-replica-set-wiredtiger/)
- [将分片集群更改为WiredTiger](https://www.mongodb.com/docs/upcoming/tutorial/change-sharded-cluster-wiredtiger/)

### 副本集

#### 删除复制集的`pv0`

MongoDB 4.0删除了已弃用的副本集协议版本0 `pv0`。

在升级到MongoDB 4.0之前，您必须升级到[`pv1`。](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.protocolVersion)

要升级到 `pv1`, 请将 `mongo` shell 连接到主副本集，并执行以下操作：

```
cfg = rs.conf();
cfg.protocolVersion=1;
rs.reconfig(cfg);
```

您可以使用[`catchUpTimeoutMillis`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.settings.catchUpTimeoutMillis)在更快的故障转移和保存[`w:1`](https://www.mongodb.com/docs/upcoming/reference/write-concern/#mongodb-writeconcern-writeconcern.-number-)写入之间进行优先排序。

有关`pv1`的更多信息，请参阅[Replica Set协议版本。](https://www.mongodb.com/docs/upcoming/reference/replica-set-protocol-versions/)

#### 删除主从复制

MongoDB 4.0取消了对已弃用的主从复制的支持。在升级到MongoDB 4.0之前，如果您的部署使用主从复制，则必须升级到副本集。

要从主从复制转换为副本集，请参阅[将主从部署转换为副本集。](https://www.mongodb.com/docs/v4.0/core/master-slave/)

#### 日志和复制集

从MongoDB 4.0开始，对于使用WiredTiger存储引擎的复制集成员，您无法指定`--nojournal`选项orstorage`storage.journal.enabled: false`。

#### `rollbackTimeLimitSecs`可用参数

从MongoDB 4.0开始，一个新的[`rollbackTimeLimitSecs`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.rollbackTimeLimitSecs)参数允许为指示回滚的成员设置公共点和最后一个oplog写入条目之间的时间限制（以秒为单位）。默认回滚时间限制为1天。

#### 等待背景索引构建

从4.0版本开始，MongoDB等待任何正在进行的[后台索引构建](https://www.mongodb.com/docs/upcoming/core/index-creation/#std-label-index-creation-background)完成，然后再开始[回滚。](https://www.mongodb.com/docs/upcoming/core/replica-set-rollbacks/)

#### 回滚文件

MongoDB添加了参数[`createRollbackDataFiles`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.createRollbackDataFiles)，该参数确定在回滚期间，MongoDB是否创建包含回滚期间受影响的文档的回滚文件。

#### `replSetGetStatus`产出变化

[`replSetGetStatus`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-dbcommand-dbcmd.replSetGetStatus)返回以下新字段：

- [`syncSourceHost`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.syncSourceHost)
- [`syncSourceId`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.syncSourceId)
- [`lastStableCheckpointTimestamp`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.lastStableCheckpointTimestamp)
- [`syncSourceHost`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.members-n-.syncSourceHost)
- [`syncSourceId`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.members-n-.syncSourceId)

不建议使用从[`replSetGetStatus`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-dbcommand-dbcmd.replSetGetStatus)返回的以下字段：

- [`replSetGetStatus.syncingTo`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.syncingTo)
- [`replSetGetStatus.members[n\].syncingTo`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.members-n-.syncingTo)

#### Oplog 大小

oplog可以超过其配置的大小限制，以避免删除[`majority commit point`。](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.lastCommittedOpTime)

### 更改流

#### 数据库和部署变更流

MongoDB增加了以下功能：

- 打开单个数据库（不包括`admin`、`local`和`config`数据库）的[更改流光标](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-changeStreams)，以监视其所有非`system`集合的更改。
- 为部署打开[更改流光标](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-changeStreams)，以监视除`admin`、`local`和`config`外所有数据库中所有非`system`集合的更改。

> 笔记：
>
> Requires `featureCompatibilityVersion` (fcv) set to `"4.0"`or greater.

#### 开始时间选项

MongoDB增加了为更改流指定开始时间（`startAtOperationTime`选项）的功能。

#### 更改事件文档更改

[更改事件文档](https://www.mongodb.com/docs/upcoming/reference/change-events/)包括新字段：

- `clusterTime`，对应于事件的职业者的时间戳。
- 如果操作是[多文档事务](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)的一部分，则`txnNumber`和`lsid`[。](https://www.mongodb.com/docs/upcoming/core/transactions/#std-label-transactions)

#### 恢复令牌数据类型更改

MongoDB 4.0引入了新的十六进制编码字符串[更改流](https://www.mongodb.com/docs/upcoming/changeStreams/)恢复令牌：

恢复令牌`_data`类型取决于MongoDB版本，在某些情况下取决于更改流打开/恢复时的功能兼容性版本（fcv）（即fcv值的更改不会影响已打开的更改流的恢复令牌）：

| MongoDB版本             | 功能兼容性版本 | 恢复令牌`_data`类型    |
| :---------------------- | :------------- | :--------------------- |
| MongoDB 4.0.7及更高版本 | "4.0"或"3.6"   | 六角编码字符串（`v1`） |
| MongoDB 4.0.6及更早版本 | "4.0"          | 六角编码字符串（`v0`） |
| MongoDB 4.0.6及更早版本 | "3.6"          | BinData                |
| MongoDB 3.6             | "3.6"          | BinData                |

使用十六进制编码的字符串恢复令牌，您可以比较和排序此类令牌。

无论fcv值如何，4.0部署都可以使用BinData恢复令牌或十六进制字符串恢复令牌来恢复更改流。因此，4.0部署可以使用3.6部署集合上打开的更改流中的恢复令牌。

在MongoDB版本中引入的新简历令牌格式不能被早期的MongoDB版本使用。

然而，3.6部署可以使用从对fcv `3.6`部署的集合打开的更改流返回的BinData恢复令牌。然而，3.6部署不能使用十六进制编码的字符串恢复令牌。

#### `mongo`shell方法

| 方法                                                         | 描述                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`db.watch()`](https://www.mongodb.com/docs/upcoming/reference/method/db.watch/#mongodb-method-db.watch) | 为单个数据库（不包括`admin`、`local`和`config`数据库）打开[更改流光标](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-changeStreams)，以监视其所有非`system`集合的更改。有关相应的MongoDB驱动程序方法，请参阅您的驱动程序文档。 |
| [`Mongo.watch()`](https://www.mongodb.com/docs/upcoming/reference/method/Mongo.watch/#mongodb-method-Mongo.watch) | 为部署打开一个[更改流光标](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-changeStreams)，以监视除`admin`、`local`和`config`外所有数据库中所有非`system`集合的更改。有关相应的MongoDB驱动程序方法，请参阅您的驱动程序文档。*4.0版本的新功能*。 |

### 免费监控

MongoDB 4.0（社区版）为独立或复制集[提供免费云监控](https://www.mongodb.com/docs/upcoming/administration/free-monitoring/)。

#### 启用/禁用

默认情况下，您可以使用以下方式在运行时启用/禁用免费监控：

| `mongo`外壳方法                                              | 指挥权                                                       |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`db.enableFreeMonitoring()`](https://www.mongodb.com/docs/upcoming/reference/method/db.enableFreeMonitoring/#mongodb-method-db.enableFreeMonitoring) | [`setFreeMonitoring`](https://www.mongodb.com/docs/upcoming/reference/command/setFreeMonitoring/#mongodb-dbcommand-dbcmd.setFreeMonitoring) |
| [`db.disableFreeMonitoring()`](https://www.mongodb.com/docs/upcoming/reference/method/db.disableFreeMonitoring/#mongodb-method-db.disableFreeMonitoring) |                                                              |

您还可以在启动时启用或禁用免费监控，使用以下任一方式：

- 配置文件设置[`cloud.monitoring.free.state`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-cloud.monitoring.free.state)或
- 命令行选项[`--enableFreeMonitoring`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--enableFreeMonitoring)

#### 查看状态

要查看免费监控的状态，MongoDB提供以下命令和shell助手：

| `mongo`shell方法                                             | 指挥权                                                       |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`db.getFreeMonitoringStatus()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getFreeMonitoringStatus/#mongodb-method-db.getFreeMonitoringStatus) | [`getFreeMonitoringStatus`](https://www.mongodb.com/docs/upcoming/reference/command/getFreeMonitoringStatus/#mongodb-dbcommand-dbcmd.getFreeMonitoringStatus) |

[`serverStatus`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-dbcommand-dbcmd.serverStatus)和助手[`db.serverStatus()`](https://www.mongodb.com/docs/upcoming/reference/method/db.serverStatus/#mongodb-method-db.serverStatus)还包括[`freeMonitoring`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.freeMonitoring)字段中的免费监控统计信息。

#### 访问控制

为了支持免费的云监控，MongoDB为`cluster`资源添加了以下特权操作：

- [`checkFreeMonitoringStatus`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-checkFreeMonitoringStatus)
- [`setFreeMonitoring`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-setFreeMonitoring)

内置的角色[`clusterMonitor`](https://www.mongodb.com/docs/upcoming/reference/built-in-roles/#mongodb-authrole-clusterMonitor)包括新的特权操作。

### 分片集群

[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)对影响分片集群元数据的以下操作使用[`"majority"`](https://www.mongodb.com/docs/upcoming/reference/write-concern/#mongodb-writeconcern-writeconcern.-majority-)写入关注：

| 指挥权                                                       | 方法                                                         | 笔记                |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :------------------ |
| [`addShard`](https://www.mongodb.com/docs/upcoming/reference/command/addShard/#mongodb-dbcommand-dbcmd.addShard) | [`sh.addShard()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.addShard/#mongodb-method-sh.addShard) |                     |
| [`create`](https://www.mongodb.com/docs/upcoming/reference/command/create/#mongodb-dbcommand-dbcmd.create) | [`db.createCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/db.createCollection/#mongodb-method-db.createCollection) |                     |
| [`drop`](https://www.mongodb.com/docs/upcoming/reference/command/drop/#mongodb-dbcommand-dbcmd.drop) | [`db.collection.drop()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.drop/#mongodb-method-db.collection.drop) |                     |
| [`dropDatabase`](https://www.mongodb.com/docs/upcoming/reference/command/dropDatabase/#mongodb-dbcommand-dbcmd.dropDatabase) | [`db.dropDatabase()`](https://www.mongodb.com/docs/upcoming/reference/method/db.dropDatabase/#mongodb-method-db.dropDatabase) | 在MongoDB 3.6中更改 |
| [`enableSharding`](https://www.mongodb.com/docs/upcoming/reference/command/enableSharding/#mongodb-dbcommand-dbcmd.enableSharding) | [`sh.enableSharding()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.enableSharding/#mongodb-method-sh.enableSharding) |                     |
| [`movePrimary`](https://www.mongodb.com/docs/upcoming/reference/command/movePrimary/#mongodb-dbcommand-dbcmd.movePrimary) |                                                              |                     |
| [`renameCollection`](https://www.mongodb.com/docs/upcoming/reference/command/renameCollection/#mongodb-dbcommand-dbcmd.renameCollection) | [`db.collection.renameCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.renameCollection/#mongodb-method-db.collection.renameCollection) |                     |
| [`shardCollection`](https://www.mongodb.com/docs/upcoming/reference/command/shardCollection/#mongodb-dbcommand-dbcmd.shardCollection) | [`sh.shardCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.shardCollection/#mongodb-method-sh.shardCollection) |                     |
| [`removeShard`](https://www.mongodb.com/docs/upcoming/reference/command/removeShard/#mongodb-dbcommand-dbcmd.removeShard) |                                                              |                     |
| [`setFeatureCompatibilityVersion`](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#mongodb-dbcommand-dbcmd.setFeatureCompatibilityVersion) |                                                              |                     |

### `.msi`Windows上的安装程序

从MongoDB 4.0开始，您可以在安装期间将MongoDB配置为服务。

### 平台支持

- MongoDB 4.0（社区和企业）增加了对以下内容的支持：
  - [Amazon Linux 2](https://www.mongodb.com/docs/upcoming/tutorial/install-mongodb-on-amazon/#std-label-install-mdb-community-amazon-linux)
  - [Debian 9 "Stretch"](https://www.mongodb.com/docs/upcoming/tutorial/install-mongodb-on-debian/#std-label-install-mdb-community-debian)
  - [Ubuntu 18.04](https://www.mongodb.com/docs/upcoming/tutorial/install-mongodb-on-ubuntu/#std-label-install-mdb-community-ubuntu)
- MongoDB 4.0（社区）增加了对以下内容的支持：
  - s390x RHEL 6.x
- MongoDB 4.0不支持SLES 11。
  - MongoDB 3.2.20+、3.4.15+和3.6.4+也取消了对SLES 11的支持。
- MongoDB 4.0不支持Ubuntu 12.04。
  - MongoDB 3.2.20+、3.4.15+和3.6.4+也删除了对Ubuntu 12.04的支持。
  - MongoDB 3.2.20+、3.4.15+和3.6.4+也删除了对Ubuntu 12.04的支持。
- 在未来版本中，MongoDB将停止对以下平台的支持：
  - Windows 7/2008R2
  - Windows 8/2012
  - Windows 8.1/2012R2
  - Ubuntu 14.04

有关完整的平台支持矩阵，请参阅[平台支持](https://www.mongodb.com/docs/upcoming/administration/production-notes/#std-label-prod-notes-supported-platforms)。

### MongoDB工具

 [`mongoreplay`](https://www.mongodb.com/docs/upcoming/reference/program/mongoreplay/#mongodb-binary-bin.mongoreplay) 命令支持一个新的`MONGOREPLAY_HOST`环境变量，该变量在运行 `mongoreplay play`时指定mongoDB连接字符串。可以使用新的环境变量来代替命令行 ` --host` 选项。

例如，要将录音播放到在`mongodb1.example.net:27017`上运行身份验证的[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)实例，您可以在以下位置指定连接字符串：

* `MONGOREPLAY_HOST`环境变量：

  ```
  export MONGOREPLAY_HOST="mongodb://myUserName:s0meD1fficultPassw0rd@mongodb1.example.net:27017/?authSource=admin"
  mongoreplay play -p /some/path/to/my/recording.bson
  ```

* `--host`命令行选项：

  ```
  mongoreplay play -p /some/path/to/my/recording.bson --host "mongodb://myUserName:s0meD1fficultPassw0rd@mongodb1.example.net:27017/?authSource=admin"
  ```

如果指定了`--host`命令行选项，则`--host`值将覆盖环境变量。

### 一般改进

#### 命令

- 命令[`listCollections`](https://www.mongodb.com/docs/upcoming/reference/command/listCollections/#mongodb-dbcommand-dbcmd.listCollections)在数据库上进行意向共享锁定。在之前的版本中，该命令对数据库进行共享锁定。
- 命令 [`listCollections`](https://www.mongodb.com/docs/upcoming/reference/command/listCollections/#mongodb-dbcommand-dbcmd.listCollections) 及其 `mongo` shell  [`db.getCollectionInfos()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getCollectionInfos/#mongodb-method-db.getCollectionInfos) 接受以下选项：
  - `nameOnly`仅返回集合名称和类型（不需要集合锁）。
  - `authorizedCollections`允许没有所需权限的用户运行[`listCollections`](https://www.mongodb.com/docs/upcoming/reference/command/listCollections/#mongodb-dbcommand-dbcmd.listCollections)可以运行命令，withnameOnly`nameOnly: true, authorizedCollections: true`，以返回用户拥有特权的集合。
- 命令 [`serverStatus`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-dbcommand-dbcmd.serverStatus) 及其 `mongo` shell 助手 [`db.serverStatus()`](https://www.mongodb.com/docs/upcoming/reference/method/db.serverStatus/#mongodb-method-db.serverStatus) 在其输出中包括 [`shardingStatistics`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics) 。 [`shardingStatistics`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics) 包括关于分片集群上元数据刷新的数据。
- `mongo` shell 辅助程序 [`db.collection.drop()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.drop/#mongodb-method-db.collection.drop) 接受写关注选项。
- 对于在会话中创建的光标，您无法在会话之外调用 [`getMore`](https://www.mongodb.com/docs/upcoming/reference/command/getMore/#mongodb-dbcommand-dbcmd.getMore)。同样，对于在会话之外创建的光标，您无法在会话中调用 [`getMore`](https://www.mongodb.com/docs/upcoming/reference/command/getMore/#mongodb-dbcommand-dbcmd.getMore)。
- [`dbHash`](https://www.mongodb.com/docs/upcoming/reference/command/dbHash/#mongodb-dbcommand-dbcmd.dbHash)命令在其输出中包含以下字段：
  - `capped`列出大写集合的字段
  - `uuids`包含集合及其对应的UUID的字段。
- [`killOp`](https://www.mongodb.com/docs/upcoming/reference/command/killOp/#mongodb-dbcommand-dbcmd.killOp)命令现在支持终止在[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)上运行的查询。当在`mongos`上运行时，[`killOp`](https://www.mongodb.com/docs/upcoming/reference/command/killOp/#mongodb-dbcommand-dbcmd.killOp)可以杀死在多个碎片中运行的查询。

#### 地理空间查询改进

- 地理空间查询运算符[`$near`](https://www.mongodb.com/docs/upcoming/reference/operator/query/near/#mongodb-query-op.-near)和[`$nearSphere`](https://www.mongodb.com/docs/upcoming/reference/operator/query/nearSphere/#mongodb-query-op.-nearSphere)现在支持对分片集合进行查询。
- 从MongoDB 4.0起，[`$geoNear`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear)聚合运算符和`geoNear`命令支持使用带有[2d](https://www.mongodb.com/docs/upcoming/core/2d/#std-label-2d-index)索引的`minDistance`选项。同样，[`$near`](https://www.mongodb.com/docs/upcoming/reference/operator/query/near/#mongodb-query-op.-near)和[`$nearSphere`](https://www.mongodb.com/docs/upcoming/reference/operator/query/nearSphere/#mongodb-query-op.-nearSphere)支持[2d](https://www.mongodb.com/docs/upcoming/core/2d/#std-label-2d-index)索引的`$minDistance`选项。以前，`minDistance`和`$minDistance`仅适用于[2dsphere](https://www.mongodb.com/docs/upcoming/core/2dsphere/#std-label-2dsphere-index)索引。
- MongoDB 4.0为[`$geoNear`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear)聚合运算符和`geoNear`命令添加了一个`key`选项，使用户能够在查询具有多个地理空间索引的集合时指定要使用的地理空间索引。以前，要使用[`$geoNear`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear)聚合运算符或`geoNear`命令，集合只能有一个地理空间索引。

#### 网络层改进

- 对于参数[`taskExecutorPoolSize`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.taskExecutorPoolSize)，请将默认值更改为1。
- 添加新参数[AsyncRequestsSenderUseBaton](https://www.mongodb.com/docs/v4.0/reference/parameters/#param.AsyncRequestsSenderUseBaton)当使用单个[`Task Executor connection pool`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.taskExecutorPoolSize)时，在Linux上启用对[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)上的散射/收集操作进行性能优化[。](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.taskExecutorPoolSize)
- 添加了以下参数来管理连接池：
  - [`connPoolMaxInUseConnsPerHost`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.connPoolMaxInUseConnsPerHost)
  - [`connPoolMaxShardedInUseConnsPerHost`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.connPoolMaxShardedInUseConnsPerHost)
  - [`globalConnPoolIdleTimeoutMinutes`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.globalConnPoolIdleTimeoutMinutes)
  - [`shardedConnPoolIdleTimeoutMinutes`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.shardedConnPoolIdleTimeoutMinutes)

#### 配置选项

- [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)支持：
  - 命令行选项：[`slowms`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#std-option-mongos.--slowms)和[`--slowOpSampleRate`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#std-option-mongos.--slowOpSampleRate)
  - 配置文件选项：[`operationProfiling.slowOpThresholdMs`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-operationProfiling.slowOpThresholdMs)和[`operationProfiling.slowOpSampleRate`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-operationProfiling.slowOpSampleRate)

#### 杂项

- 默认情况下，JavaScript引擎的JIT编译器现在被禁用。
- 将MozJS升级到ESR 45.9.0。
- 将[`RECOVERY`](https://www.mongodb.com/docs/upcoming/reference/log-messages/#mongodb-data-RECOVERY)组件添加到日志消息中。
- MongoDB 4.0 增加了对使用 [`appName`](https://www.mongodb.com/docs/upcoming/reference/connection-string/#mongodb-urioption-urioption.appName) 连接字符串的选项支持，用于在从mongo shell 连接时设置自定义应用程序名称。以前，只有MongoDB驱动程序支持使用 [`appName`](https://www.mongodb.com/docs/upcoming/reference/connection-string/#mongodb-urioption-urioption.appName)设置自定义值，mongo shell 使用默认MongoDB Shell 值作为应用程序名称。
- 添加 `mongo` shell 方法 [`convertShardKeyToHashed()`](https://www.mongodb.com/docs/upcoming/reference/method/convertShardKeyToHashed/#mongodb-method-convertShardKeyToHashed) 以返回文档的哈希值。
- 按照配置解析`localhost`IP地址，而不是假设`127.0.0.1`。
- 当使用 [DNS Seed List Connection Format](https://www.mongodb.com/docs/upcoming/reference/connection-string/#std-label-connections-dns-seedlist) 通过身份验证连接到mongo shell 时，mongo shell 现在会在启动时提示用户提供密码。

### 影响兼容性的变化

一些更改可能会影响兼容性，可能需要用户采取行动。有关兼容性更改的详细列表，请参阅[MongoDB 4.0中的兼容性更改。](https://www.mongodb.com/docs/upcoming/release-notes/4.0-compatibility/)

### 升级程序

> ##### 功能兼容性版本
>
> 要升级，3.6实例必须将`featureCompatibilityVersion`设置为`3.6`。要检查版本：
>
> ```
> db.adminCommand( { getParameter: 1, featureCompatibilityVersion: 1 } )
> ```
>
> 有关验证和设置`featureCompatibilityVersion`的具体详细信息，以及有关升级的其他先决条件/考虑的信息，请参阅单独的升级说明：
>
> - [将独立版升级到4.0](https://www.mongodb.com/docs/upcoming/release-notes/4.0-upgrade-standalone/)
> - [将副本集升级到4.0](https://www.mongodb.com/docs/upcoming/release-notes/4.0-upgrade-replica-set/)
> - [将分片集群升级到4.0](https://www.mongodb.com/docs/upcoming/release-notes/4.0-upgrade-sharded-cluster/)

如果您需要升级到4.0的指导，[MongoDB提供主要版本升级服务](https://www.mongodb.com/products/consulting?tck=docs_server)帮助确保顺利过渡到您的MongoDB应用程序而不中断。

### 下载

要下载MongoDB 4.0，请转到[MongoDB下载中心](https://www.mongodb.com/download-center/community?tck=docs_server)

> 另见：
>
> [所有第三方许可通知](https://github.com/mongodb/mongo/blob/v4.0/distsrc/THIRD-PARTY-NOTICES)。

### 4.0.3中的已知问题

- [WT-4018](https://jira.mongodb.org/browse/WT-4018)：MongoDB 4.0可能会在macOS 10.12.x、10.13.x和10.14.0的不干净关机期间丢失数据。Apple 在 macOS 10.14.1 中修复了这个问题。
- [服务器-35431](https://jira.mongodb.org/browse/SERVER-35431)：回滚后，[`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)和[`dbStats`](https://www.mongodb.com/docs/upcoming/reference/command/dbStats/#mongodb-dbcommand-dbcmd.dbStats)输出中报告的“dataSize”字段可能不准确。

### 4.0.2中的已知问题

- [WT-4018](https://jira.mongodb.org/browse/WT-4018)：MongoDB 4.0可能会在macOS 10.12.x、10.13.x和10.14.0的不干净关机期间丢失数据。Apple 在 macOS 10.14.1 中修复了这个问题。
- [服务器-35431](https://jira.mongodb.org/browse/SERVER-35431)：回滚后，[`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)和[`dbStats`](https://www.mongodb.com/docs/upcoming/reference/command/dbStats/#mongodb-dbcommand-dbcmd.dbStats)输出中报告的“dataSize”字段可能不准确。
- [服务器-35657](https://jira.mongodb.org/browse/SERVER-35657)：使用具有单成员副本集的多文档事务可能会对性能产生重大影响。单成员复制集仅应用于测试/开发目的，不建议用于生产。

>笔记：
>
>单成员副本集上的多文档事务性能并不表示具有多个成员的副本集的性能。

### 4.0.1中的已知问题

- [WT-4018](https://jira.mongodb.org/browse/WT-4018)：MongoDB 4.0可能会在macOS 10.12.x、10.13.x和10.14.0的不干净关机期间丢失数据。Apple 在 macOS 10.14.1 中修复了这个问题。
- [服务器-35431](https://jira.mongodb.org/browse/SERVER-35431)：回滚后，[`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)和[`dbStats`](https://www.mongodb.com/docs/upcoming/reference/command/dbStats/#mongodb-dbcommand-dbcmd.dbStats)输出中报告的“dataSize”字段可能不准确。
- [服务器-35657](https://jira.mongodb.org/browse/SERVER-35657)：使用具有单成员副本集的多文档事务可能会对性能产生重大影响。单成员复制集仅应用于测试/开发目的，不建议用于生产。

> 笔记：
>
> 单成员副本集上的多文档事务性能并不表示具有多个成员的副本集的性能。

### 4.0.0中的已知问题

- [工具-1952](https://jira.mongodb.org/browse/TOOLS-1952)：运行MongoDB 4.0的用户[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)与之前的版本相比，性能可能会较慢。跑步[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)使用`--forceTableScan`可以解决性能问题。
- [工具-2058](https://jira.mongodb.org/browse/TOOLS-2058)：[`mongoreplay`](https://www.mongodb.com/docs/upcoming/reference/program/mongoreplay/#mongodb-binary-bin.mongoreplay)没有显示MongoDB 4.0的插入/查找命令。# 修复在4.0.1
- [WT-4018](https://jira.mongodb.org/browse/WT-4018)：MongoDB 4.0可能会在macOS 10.12.x、10.13.x和10.14.0的不干净关机期间丢失数据。Apple 在 macOS 10.14.1 中修复了这个问题。
- [服务器-35431](https://jira.mongodb.org/browse/SERVER-35431)：回滚后，[`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)和[`dbStats`](https://www.mongodb.com/docs/upcoming/reference/command/dbStats/#mongodb-dbcommand-dbcmd.dbStats)输出中报告的“dataSize”字段可能不准确。
- [服务器-35657](https://jira.mongodb.org/browse/SERVER-35657)：使用具有单成员副本集的多文档事务可能会对性能产生重大影响。单成员复制集仅应用于测试/开发目的，不建议用于生产。

> 笔记：
>
> 单成员副本集上的多文档事务性能并不表示具有多个成员的副本集的性能。

- [服务器-35758](https://jira.mongodb.org/browse/SERVER-35758)：如果您使用与全局对象关联的会话来运行事务，则 `mongo` shell 中的shell提示符将导致错误

### 报告问题

要报告问题，请参阅https://github.com/mongodb/mongo/wiki/Submit-Bug-Reports关于如何为MongoDB服务器或相关项目之一提交JIRA票据的指导。





译者：韩鹏帅
参见

原文 - [Release Notes for MongoDB 4.0]( https://docs.mongodb.com/manual/release-notes/4.0/ )

