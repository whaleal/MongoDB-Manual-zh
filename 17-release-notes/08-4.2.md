# MongoDB 4.2的发布说明

### 分布式索引

> 笔记：
>
> ##### 分布式交易和多文档交易
>
> 从MongoDB 4.2开始，这两个术语是同义词。分布式事务是指分片集群和副本集上的多文档事务。多文档事务（无论是在分片集群还是复制集上）也被称为从MongoDB 4.2开始的分布式事务

在4.2版本中，MongoDB引入了分布式事务。分布式交易：

- 增加了对分片集群上多文档事务的支持。
  - 4.2分片集群的所有成员都必须具有`4.2`的[特征兼容性版本](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)。
  - 客户端**必须**使用为MongoDB 4.2更新的MongoDB驱动程序
- 包含对复制集上事务的现有支持。
  - 4.2副本集的所有成员必须具有`4.2`的[特征兼容性版本](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)。
  - 客户端**必须**使用为MongoDB 4.2更新的MongoDB驱动程序
- 移除了交易的 16MB 总大小限制。在4.2版本中，MongoDB根据需要创建尽可能多的oplog条目（每个最大大小为`16MB`），以封装事务中的所有写入操作。在MongoDB 4.0中，MongoDB为事务中的所有写入操作创建一个条目，从而对事务施加16MB的总大小限制。
- 将事务支持扩展到其次要成员使用[内存存储引擎](https://www.mongodb.com/docs/upcoming/core/inmemory/#std-label-storage-inmemory)的部署。也就是说，事务可用于使用WiredTiger存储引擎进行主服务器，以及WiredTiger或辅助成员内存存储引擎的部署。在MongoDB 4.0中，交易仅适用于仅使用WiredTigerstorage引擎的部署。

有关更多信息，请参阅[交易。](https://www.mongodb.com/docs/upcoming/core/transactions/)

> 另见：
>
> [4.2 交易兼容性变更](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compatibility-txn)

### 移除了MMAPv1存储引擎

MongoDB 4.2删除了已弃用的MMAPv1存储引擎。

如果您的4.0部署使用MMAPv1，则在升级到MongoDB 4.2之前，您必须将部署更改为[WiredTiger存储引擎](https://www.mongodb.com/docs/upcoming/core/wiredtiger/)。有关详细信息，请参阅：

- [将“独立产品”更改为“WiredTiger”](https://www.mongodb.com/docs/upcoming/tutorial/change-standalone-wiredtiger/)
- [将副本集更改为WiredTiger](https://www.mongodb.com/docs/upcoming/tutorial/change-replica-set-wiredtiger/)
- [将分片集群更改为WiredTiger](https://www.mongodb.com/docs/upcoming/tutorial/change-sharded-cluster-wiredtiger/)

#### MMAPv1特定配置选项

MongoDB删除了以下MMAPv1特定配置选项：

| 移除了配置文件设置                        | 删除了命令行选项             |
| :---------------------------------------- | :--------------------------- |
| `storage.mmapv1.journal.commitIntervalMs` |                              |
| `storage.mmapv1.journal.debugFlags`       | `mongod --journalOptions`    |
| `storage.mmapv1.nsSize`                   | `mongod --nssize`            |
| `storage.mmapv1.preallocDataFiles`        | `mongod --noprealloc`        |
| `storage.mmapv1.quota.enforced`           | `mongod --quota`             |
| `storage.mmapv1.quota.maxFilesPerDB`      | `mongod --quotaFiles`        |
| `storage.mmapv1.smallFiles`               | `mongod --smallfiles`        |
| `storage.repairPath`                      | `mongod --repairpath`        |
| `replication.secondaryIndexPrefetch`      | `mongod --replIndexPrefetch` |

> 笔记：
>
> 从4.2版本开始，MongoDB进程不会从这些选项开始。如果使用WiredTiger部署，请删除任何特定于MMAPv1的配置选项。

#### MMAPv1特定参数

MongoDB删除了以下MMAPv1参数：

- `newCollectionsUsePowerOf2Sizes`
- `replIndexPrefetch`

#### MMAPv1特定命令

MongoDB删除了MMAPv1特定的`touch`命令。

#### MMAPv1二进制文件、命令和方法的特定选项

MongoDB删除了MMAPv1特定选项：

- `noPadding``usePowerOf2Sizes`[`collMod`](https://www.mongodb.com/docs/upcoming/reference/command/collMod/#mongodb-dbcommand-dbcmd.collMod)
- `verbose`为了[`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)
- `flags`为了[`create`](https://www.mongodb.com/docs/upcoming/reference/command/create/#mongodb-dbcommand-dbcmd.create)
- 为[`db.createCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/db.createCollection/#mongodb-method-db.createCollection)方法和 [`compact`](https://www.mongodb.com/docs/upcoming/reference/command/compact/#mongodb-dbcommand-dbcmd.compact)命令提供paddingFactor、paddingBytes和preservePadding。
- `repair`为了[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)

### 移除了命令和方法

| 删除了命令               | 删除方法                | 备注                                                         |
| :----------------------- | :---------------------- | :----------------------------------------------------------- |
| `group`                  | `db.collection.group()` | [`db.collection.aggregate()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate)代替[`$group`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/group/#mongodb-pipeline-pipe.-group)阶段。 |
| `eval`                   |                         | MongoDB 4.2 mongo shell方法db.eval（）和db.collection.copyTo（）只能在连接到MongoDB 4. 0或更早版本时运行。 |
| `copydb`                 |                         | 对应的mongo shell助手db.copyDatabase（）只能在连接到MongoDB 4. 0或更早版本时运行。作为替代方案，用户可以使用[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)和[`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)（见[复制和克隆数据库](https://www.mongodb.com/docs/database-tools/mongodump/#std-label-mongodump-example-copy-clone-database)）或使用驱动程序编写脚本。 |
| `clone`                  |                         | 对应的mongo shell助手db.cloneDatabase（）只能在连接到MongoDB 4. 0或更早版本时运行 .作为替代方案，用户可以使用[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)和[`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)（见[复制和克隆数据库](https://www.mongodb.com/docs/database-tools/mongodump/#std-label-mongodump-example-copy-clone-database)）或使用驱动程序编写脚本。 |
| `geoNear`                |                         | [`db.collection.aggregate()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate)代替[`$geoNear`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/geoNear/#mongodb-pipeline-pipe.-geoNear)阶段。有关更多信息，请参阅[删除对`geoNear`命令的支持。](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compat-remove-geoNear) |
| `parallelCollectionScan` |                         |                                                              |
| `repairDatabase`         | `db.repairDatabase()`   | 有关更多信息，请参阅[删除对 therepairDatabase命令的支持。](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compat-remove-repairDatabase) |
| `getPrevError`           | `db.getPrevError()`     |                                                              |

#### 删除`maxScan`选项

MongoDB删除了`maxScan`该  [`find`](https://www.mongodb.com/docs/upcoming/reference/command/find/#mongodb-dbcommand-dbcmd.find)命令和`mongo`shell助手 的不推荐使用的选项`cursor.maxScan()`。请使用命令`maxTimeMS`选项  [`find`](https://www.mongodb.com/docs/upcoming/reference/command/find/#mongodb-dbcommand-dbcmd.find)或帮助程序[`cursor.maxTimeMS()`](https://www.mongodb.com/docs/upcoming/reference/method/cursor.maxTimeMS/#mongodb-method-cursor.maxTimeMS)。

### MongoDB驱动程序

以下驱动程序的功能与MongoDB 4.2兼容[1]：

|                                                              |                                                              |                                                              |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [C 1.15.0](http://mongoc.org/libmongoc/)                     | [Java 3.11.0](https://mongodb.github.io/mongo-java-driver/)  | [Python 3.9.0](https://api.mongodb.com/pymongo)              |
| [C# 2.9.0](https://mongodb.github.io/mongo-csharp-driver/)   | [Node 3.3.0](https://mongodb.github.io/node-mongodb-native/) | [Ruby 2.10.0](https://www.mongodb.com/docs/ruby-driver/current/) |
| [Go 1.1](https://godoc.org/go.mongodb.org/mongo-driver/mongo) | [Perl 2.2.0](https://metacpan.org/author/MONGODB)            | [Scala 2.7.0](https://mongodb.github.io/mongo-scala-driver/) |

有关支持客户端现场级加密的官方4.2+兼容驱动程序的完整列表，请参阅[兼容性。](https://www.mongodb.com/docs/upcoming/core/csfle/reference/compatibility/#std-label-field-level-encryption-drivers)

#### 可重试阅读

可重试读取允许MongoDB 4.2+兼容驱动程序在遇到某些网络或服务器错误时一次性自动重试某些读取操作。有关更多信息，请参阅[可重试阅读](https://www.mongodb.com/docs/upcoming/core/retryable-reads/#std-label-retryable-reads)。

### 分片集群

#### 可变分片键值

从MongoDB 4.2开始，您可以更新文档的分块键值，除非分片键字段是不可变的`_id`字段。在MongoDB 4.2及更低版本中，文档的分片键字段值是不可变的。

有关更新碎片键的详细信息，请参阅[更改文档的碎片密钥值。](https://www.mongodb.com/docs/upcoming/core/sharding-change-shard-key-value/#std-label-update-shard-key)

#### 备份

[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)和[`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore) **不能**成为4.2多个分片集群的备份策略的一部分，这些集群已经分片正在进行中事务，因为备份创建时使用[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump) *不要保持*跨碎片交易的原子性保证。

对于4.2多个具有进行中的分片事务的分片集群，请使用以下协调备份和还原流程之一，这些流程*确实保持*了跨碎片事务的原子性保证：

- [MongoDB Atlas](https://www.mongodb.com/cloud/atlas?tck=docs_server),
- [MongoDB Cloud Manager](https://www.mongodb.com/cloud/cloud-manager?tck=docs_server), 或
- [MongoDB Ops Manager](https://www.mongodb.com/products/ops-manager?tck=docs_server).

#### 平衡器状态和自动拆分

从MongoDB 6.1开始，不执行自动分割块。这是因为平衡了政策的改进。自动拆分命令仍然存在，但不执行操作。有关详细信息，请参阅[平衡策略更改。](https://www.mongodb.com/docs/upcoming/release-notes/6.1/#std-label-release-notes-6.1-balancing-policy-changes)

在6.1之前的MongoDB版本中：

- 该 [`balancerStart`](https://www.mongodb.com/docs/upcoming/reference/command/balancerStart/#mongodb-dbcommand-dbcmd.balancerStart) 命令和 `mongo` shell帮助程序方法 [`sh.startBalancer()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.startBalancer/#mongodb-method-sh.startBalancer) and [`sh.setBalancerState(true)`](https://www.mongodb.com/docs/upcoming/reference/method/sh.setBalancerState/#mongodb-method-sh.setBalancerState) 还启用了分片群集的自动拆分

  要在启用平衡器时禁用自动拆分，您可以使用[`sh.disableAutoSplit()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.disableAutoSplit/#mongodb-method-sh.disableAutoSplit)。

- 该 [`balancerStop`](https://www.mongodb.com/docs/upcoming/reference/command/balancerStop/#mongodb-dbcommand-dbcmd.balancerStop) 命令和 `mongo` shell帮助程序方法 [`sh.stopBalancer()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.stopBalancer/#mongodb-method-sh.stopBalancer) [`sh.setBalancerState(false)`](https://www.mongodb.com/docs/upcoming/reference/method/sh.setBalancerState/#mongodb-method-sh.setBalancerState) 还禁用分片群集的自动拆分。

  要在禁用平衡器时启用自动拆分，您可以使用[`sh.enableAutoSplit()`](https://www.mongodb.com/docs/upcoming/reference/method/sh.enableAutoSplit/#mongodb-method-sh.enableAutoSplit)。

`mongo`方法[`sh.enableBalancing(namespace)`](https://www.mongodb.com/docs/upcoming/reference/method/sh.enableBalancing/#mongodb-method-sh.enableBalancing)和[`sh.disableBalancing(namespace)`](https://www.mongodb.com/docs/upcoming/reference/method/sh.disableBalancing/#mongodb-method-sh.disableBalancing)对自动分割没有影响。

#### `mongos`/ `mongod`连接池

从MongoDB 4.2开始, MongoDB添加参数[`ShardingTaskExecutorPoolReplicaSetMatching`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.ShardingTaskExecutorPoolReplicaSetMatching)。此参数o定[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) / [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos) 实例到分片集群的每个成员的连接池的最小大小。此值在运行时可能会有所变化。

[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)维护与分片集群中每个副本集的辅助副本集的连接池。默认情况下，这些池具有至少与主池的连接数量。

要修改，请参阅[`ShardingTaskExecutorPoolReplicaSetMatching`。](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.ShardingTaskExecutorPoolReplicaSetMatching)

#### 分片收集和替换文档

从MongoDB 4.2开始，

- 替换文档的操作，例如 [`replaceOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne) or [`update()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.update/#mongodb-method-db.collection.update) (when used with a replacement 文档），将首先尝试使用 查询筛选器。如果操作无法通过 查询筛选器，然后尝试通过替换来定位 文件。在早期版本中，这些操作仅尝试 使用替换文档的目标。
- 不建议使用`save()`方法：改用[`insertOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.insertOne/#mongodb-method-db.collection.insertOne)或[`replaceOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne)方法。`save()`方法不能与`_id`*未*分片的分片集合一起使用，尝试这样做将导致错误。
- 对于包含`upsert: true`且在分片集合上的替换文档操作，`filter`必须在全分片键上包含相等匹配。

### 安全改进

#### 已解决的常见漏洞和暴露

MongoDB 4.2包含修复程序，可解决以下常见问题 漏洞和风险（CVE）：

- CVE-2019-2389（见[服务器-40563）](https://jira.mongodb.org/browse/SERVER-40563)
- CVE-2019-2386（见[服务器-38984）](https://jira.mongodb.org/browse/SERVER-38984)

#### 新的`TLS`选项

MongoDB 4.2为[mongod](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-label-tls-mongod-options)、[mongos](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#std-label-mongos-tls-options)和`mongo shell`添加了`TLS`选项，以取代相应的`SSL`选项（在4.2中不建议使用）。新的TLS选项提供了与已弃用的`SSL`选项**相同的**功能，因为MongoDB一直支持TLS 1.0及更高版本。

- 对于命令行TLS选项，请参考 [mongod](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-label-tls-mongod-options), [mongos](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#std-label-mongos-tls-options), 和mongo shell页面
- 有关相应的`mongod`和`mongos`配置文件选项，请参阅[配置文件](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#std-label-net-tls-conf-options)页面。
- 有关连接字符串`tls`选项，请参阅[连接字符串](https://www.mongodb.com/docs/upcoming/reference/connection-string/#std-label-uri-options-tls)页面。

> 提示：
>
>  大多数新的`TLS`选项名称都与`SSL`名称相似；例如[`--tlsMode`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--tlsMode)而不是[`--sslMode`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--sslMode)。例外情况是：
>
> - [`net.tls.certificateKeyFile`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.tls.certificateKeyFile)vs.[`net.ssl.PEMKeyFile`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.PEMKeyFile)
> - [`net.tls.certificateKeyFilePassword`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.tls.certificateKeyFilePassword)vs.[`net.ssl.PEMKeyPassword`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.ssl.PEMKeyPassword)
> - [`--tlsCertificateKeyFile`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--tlsCertificateKeyFile)vs.[`--sslPEMKeyFile`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--sslPEMKeyFile)
> - [`--tlsCertificateKeyFilePassword`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--tlsCertificateKeyFile)vs.[`--sslPEMKeyPassword`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--sslPEMKeyPassword)

> 另见：
>
> [新的`tlsClusterCAFile`选项](https://www.mongodb.com/docs/upcoming/release-notes/4.2/#std-label-4.2-tlsclustercafile)

#### 已弃用的`SSL`选项

MongoDB 4.2不推荐使用mongod、mongos和mongo shell的SSL选项以及相应的net.ssl Options配置文件选项。

使用新的[TLS](https://www.mongodb.com/docs/upcoming/release-notes/4.2/#std-label-4.2-tls)改为选项。

#### 新的`tls`参数

| 新参数                                                       | 描述                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`tlsWithholdClientCertificate`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.tlsWithholdClientCertificate) | 适用于 [`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) 以及 [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)， 该参数可以被设置为 `true` 停止实例 发送其 `TLS` 启动群集内时的证书 与他人的通信 [`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) 或 [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos) 实例。有关详细信息，请参见 [`tlsWithholdClientCertificate`。](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.tlsWithholdClientCertificate) |
| [`tlsX509ClusterAuthDNOverride`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.tlsX509ClusterAuthDNOverride) | 适用于[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)和[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)，该参数可以设置为替代证书`DN`，用于[x.509会员身份验证](https://www.mongodb.com/docs/upcoming/tutorial/configure-x509-member-authentication/)。有关详细信息，请参阅[`tlsX509ClusterAuthDNOverride`。](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.tlsX509ClusterAuthDNOverride)您可以使用此参数滚动更新证书到包含新`DN`值的新证书。请参阅[包含新DN的x.509集群证书的滚动更新。](https://www.mongodb.com/docs/upcoming/tutorial/rotate-x509-membership-certificates/) |

#### 新的`tlsClusterCAFile`选项

MongoDB 4.2为[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)和[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)添加了[`--tlsClusterCAFile`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--tlsClusterCAFile)选项/[`net.tls.clusterCAFile`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.tls.clusterCAFile)，该选项指定了一个`.pem`文件，用于从建立连接的客户端验证TLS证书。这允许您使用单独的证书颁发机构来验证TLS握手的客户端到服务器和服务器到客户端部分。

> 另见：
>
> [新的`TLS`选项](https://www.mongodb.com/docs/upcoming/release-notes/4.2/#std-label-4.2-tls)

#### 前向保密

从Linux上的4.2版本开始：

- 如果平台的OpenSSL支持椭圆曲线Diffie-Hellman的自动曲线选择，MongoDB支持[Ephemeral Elliptic Curve Diffie-Hellman（ECDHE）。](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-ecdhe)
- 如果平台的OpenSSL不支持椭圆曲线Diffie-Hellman的自动曲线选择，MongoDB尝试使用`prime256v1`作为命名曲线启用ECDHE支持。
- 如果启用了对ECDHE的支持，如果没有显式启用[Ephemeral ](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)[Diffie-](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)[Hellman（DHE），](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)MongoDB将尝试启用对[Ephemeral ](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)[Diffie-](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)[Hellman](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)[（DHE）](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-dhe)的支持。

在早期版本的MongoDB（3.6.14+和4.0.3+）中，如果Linux平台的OpenSSL支持ECDH参数的自动曲线选择，则MongoDB支持短暂椭圆曲线Diffie-Hellman（ECDHE）。

在Windows和macOS上，MongoDB对ECDHE和DH的支持与早期版本保持不变；也就是说，通过使用平台各自的原生TLS/SSL操作系统库，支持是隐含的。

有关更多信息，请参阅[前瞻性保密。](https://www.mongodb.com/docs/upcoming/core/security-transport-encryption/#std-label-tls-forward-secrecy)

#### `passwordPrompt()`

从mongo shell的4.2版开始，您可以将[`passwordPrompt()`](https://www.mongodb.com/docs/upcoming/reference/method/passwordPrompt/#mongodb-method-passwordPrompt)方法与各种 用户身份验证/管理方法/命令结合使用，以提示输入密码，而不是直接在 方法/命令调用中指定密码。但是,您仍然可以像使用早期版本的mong。 shell那样直接指定密码。

例如：

```shell
db.createUser( {
   user:"user123",
   pwd: passwordPrompt(),   // Instead of specifying the password in cleartext
   roles:[ "readWrite" ]
} )
```

#### 密钥文件格式更改为YAML

从MongoDB 4.2开始，[用于内部成员身份验证的密钥文件](https://www.mongodb.com/docs/upcoming/core/security-internal-authentication/#std-label-internal-auth-keyfile)使用YAML格式允许密钥文件中的多个密钥。YAML格式接受以下内容：

- 单个键字符串（与早期版本相同），
- 多个键字符串（每个字符串必须用引号括起来），或
- 键串序列。

YAML格式与使用文本文件格式的现有单键密钥文件兼容。

新格式允许在不停机的情况下滚动升级按键。请参阅[复制集的旋转键](https://www.mongodb.com/docs/upcoming/tutorial/rotate-key-replica-set/)和[碎片集群的旋转键。](https://www.mongodb.com/docs/upcoming/tutorial/rotate-key-sharded-cluster/)

#### `libldap`和`libldap_r`

对于针对`libldap`链接的MongoDB 4.2企业二进制文件（例如在RHEL上运行时），对`libldap`的访问是同步的，会产生一些性能/延迟成本。

对于与`libldap_r`链接的MongoDB 4.2企业二进制文件，与早期的MongoDB版本相比，行为没有变化。

#### 加密存储引擎

对于配置了`AES256-GCM`密码的[加密存储引擎](https://www.mongodb.com/docs/upcoming/core/security-encryption-at-rest/#std-label-encrypted-storage-engine)：

- 从热备份恢复

  从4.2开始，如果您从通过“热”备份（即[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)正在运行）获取的文件恢复，MongoDB可以在启动时检测到“脏”密钥，并自动滚动数据库密钥，以避免IV（初始化矢量）重用。

- 从冷备份恢复

  但是，如果您从通过“冷”备份（即它们没有运行）进行恢复，MongoDB无法在启动时检测到“脏”密钥，重复使用IV使机密性和完整性保证无效。从4.2开始，为了避免从冷文件系统快照恢复后重用密钥，MongoDB添加了一个新的命令行选项[`--eseDatabaseKeyRollover`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--eseDatabaseKeyRollover)。当使用[`--eseDatabaseKeyRollover`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--eseDatabaseKeyRollover)选项时，[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)实例滚动到配置为`AES256-GCM`密码的数据库密钥上并退出。

有关更多信息，请参阅[加密存储引擎](https://www.mongodb.com/docs/upcoming/core/security-encryption-at-rest/#std-label-encrypted-storage-engine)和[`--eseDatabaseKeyRollover`。](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--eseDatabaseKeyRollover)

#### 客户端字段级加密

官方的[MongoDB 4.2+兼容驱动程序](https://www.mongodb.com/docs/upcoming/core/csfle/reference/compatibility/#std-label-field-level-encryption-drivers)提供了一个客户端字段级加密框架。应用程序可以在通过电线将数据传输到服务器*前*加密文档中的字段。只有能够访问正确加密密钥的应用程序才能解密和读取受保护的数据。删除加密密钥将使使用该密钥加密的所有数据永久不可读。

有关支持客户端字段级加密的官方4.2+兼容驱动程序的完整列表，请参阅[兼容性。](https://www.mongodb.com/docs/upcoming/core/csfle/reference/compatibility/#std-label-field-level-encryption-drivers)

有关使用选择MongoDB 4.2+兼容驱动程序配置字段级加密的端到端过程，请参阅[客户端字段级加密指南。](https://www.mongodb.com/docs/drivers/security/client-side-field-level-encryption-guide/)

##### 字段的显式（手动）加密

官方MongoDB 4.2+兼容驱动程序和MongoDB 4.2或更高版本 `mongo` shell支持显式加密或解密 具有特定数据加密密钥和加密算法的字段。

应用程序必须修改与构建读写操作相关的任何代码，以通过驱动程序加密库包含加密/解密逻辑。应用程序负责在每次操作的基础上选择适当的数据加密密钥进行加密/解密。

有关更多信息，请参阅[显式加密。](https://www.mongodb.com/docs/upcoming/core/csfle/fundamentals/manual-encryption/#std-label-csfle-fundamentals-manual-encryption)

##### 字段自动加密

> 企业功能
>
> 现场级加密的自动功能仅在MongoDB Enterprise 4.2或更高版本和MongoDB Atlas 4.2或更高版本集群中可用。

官方MongoDB 4.2+兼容驱动程序和MongoDB 4.2或更高版本 mongoShell支持在读写操作中自动加密字段。

应用程序必须使用自动加密配置设置创建数据库连接对象（例如`MongoClient`）。配置设置必须包括使用严格子集的自动加密加密规则[JSON Schema Draft 4标准语法](https://tools.ietf.org/html/draft-zyp-json-schema-04)和特定于加密的模式关键字。应用程序不必修改与构建读/写操作相关的代码。有关自动加密规则的完整文档，请参阅[加密模式](https://www.mongodb.com/docs/upcoming/core/csfle/reference/encryption-schemas/#std-label-field-level-encryption-json-schema)。

有关更多信息，请参阅[自动加密](https://www.mongodb.com/docs/upcoming/core/csfle/fundamentals/automatic-encryption/#std-label-field-level-encryption-automatic)

有关客户端字段级加密的完整文档，请参阅[客户端字段级加密。](https://www.mongodb.com/docs/upcoming/core/csfle/#std-label-manual-csfle-feature)

#### 一般安全增强功能

- 将[`serverStatus`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-serverStatus)添加到[`backup`](https://www.mongodb.com/docs/upcoming/reference/built-in-roles/#mongodb-authrole-backup)内置角色中。

- 要通过TLS/SSL连接连接客户端，MongoDB 4.2支持IP地址匹配以及主题替代名称（SAN）匹配的DNS。

  例如，[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)实例的x.509证书具有以下SAN

  ```
  X509v3 Subject Alternative Name:
      DNS:hostname.example.com, DNS:localhost, IP Address:127.0.0.1
  ```

  然后，要将mongo shell连接道实例，您可以指定127.0.0.1的主机或DNS名称

  * ```shell
    mongo "mongodb:\\127.0.0.1:27017\test" --tls --tlsCAFile /etc/ssl/ca.pem ...
    ```
  
  * ```shell
    "mongodb:\\hostname.example.com:27017\test" --tls --tlsCAFile /etc/ssl/ca.pem ...
    ```
  
  * ```shell
    mongo "mongodb:\\localhost:27017\test" --tls --tlsCAFile /etc/ssl/ca.pem ...
    ```
  
  在之前的版本中，MongoDB仅支持用于SAN匹配的DNS条目。
  
- * ```
    mongo "mongodb:\\hostname.example.com:27017\test" --tls --tlsCAFile /etc/ssl/ca.pem ...
    ```

  * ```
    mongo "mongodb:\\localhost:27017\test" --tls  --tlsCAFile /etc/ssl/ca.pem ...
    ```

#### LDAP查询模板`{PROVIDED_USER}`令牌

从4.2版本开始，MongoDB Enterprise添加了一个新的令牌`{PROVIDED_USER}`，可用于insecurity[`security.ldap.authz.queryTemplate`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-security.ldap.authz.queryTemplate)。在模板中使用时，MongoDB会替换提供的用户名，即在身份验证或[`LDAP transformation`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-security.ldap.userToDNMapping)之前[。](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-security.ldap.userToDNMapping)

### 聚合改进

#### 按需实例化视图（`$merge`阶段）

MongoDB 4.2增加了[`$merge`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge)聚合阶段。

在新阶段，您可以：

- 可以输出到相同或不同数据库中的集合。
- 可以将结果（合并文档、替换文档、保留现有文档、操作失败、使用自定义更新管道处理文档）集成到现有集合中。
- 可以输出到现有的分片集合。

新阶段允许用户创建[按需实例化视图](https://www.mongodb.com/docs/upcoming/core/materialized-views/)，每次运行管道时都可以逐步更新输出集合的内容。

#### 聚合三角学表达式

MongoDB 4.2添加了新的三角学表达式，用于聚合管道。

三角学表达式对数字执行三角运算。表示角度的值总是以弧度输入或输出。使用[`$degreesToRadians`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/degreesToRadians/#mongodb-expression-exp.-degreesToRadians)和[`$radiansToDegrees`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/radiansToDegrees/#mongodb-expression-exp.-radiansToDegrees)在度量和弧度测量之间转换。

| 姓名                                                         | 描述                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`$sin`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/sin/#mongodb-expression-exp.-sin) | 返回以弧度测量的值的正弦。                                   |
| [`$cos`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/cos/#mongodb-expression-exp.-cos) | 返回以弧度测量的值的余弦。                                   |
| [`$tan`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/tan/#mongodb-expression-exp.-tan) | 返回以弧度测量的值的切线。                                   |
| [`$asin`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/asin/#mongodb-expression-exp.-asin) | 以弧度为单位返回值的逆 sin（弧正弦）。                       |
| [`$acos`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/acos/#mongodb-expression-exp.-acos) | 返回以弧度为单位的值的逆余弦（弧余弦）。                     |
| [`$atan`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/atan/#mongodb-expression-exp.-atan) | 返回以弧度为单位的值的逆切线（弧切线）。                     |
| [`$atan2`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/atan2/#mongodb-expression-exp.-atan2) | 返回`y / x`在弧度中的逆切线（弧切线），其中`y`和`x`分别是传递给表达式的第一个和第二个值。 |
| [`$asinh`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/asinh/#mongodb-expression-exp.-asinh) | 返回弧度值的逆双曲正弦（双曲弧正弦）。                       |
| [`$acosh`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/acosh/#mongodb-expression-exp.-acosh) | 返回弧度值的逆双曲余弦（双曲弧余弦）。                       |
| [`$atanh`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/atanh/#mongodb-expression-exp.-atanh) | 返回弧度值的逆双曲切线（双曲弧切线）。                       |
| [`$sinh`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/sinh/#mongodb-expression-exp.-sinh) | 返回测量到的内膜值的双曲正弦。                               |
| [`$cosh`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/cosh/#mongodb-expression-exp.-cosh) | 返回测量的内亚线值的双曲余弦。                               |
| [`$tanh`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/tanh/#mongodb-expression-exp.-tanh) | 返回测量到的内膜值的双曲切线。                               |
| [`$degreesToRadians`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/degreesToRadians/#mongodb-expression-exp.-degreesToRadians) | 将值从度转换为弧度。                                         |
| [`$radiansToDegrees`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/radiansToDegrees/#mongodb-expression-exp.-radiansToDegrees) | 将值从弧度转换为度。                                         |

#### 聚合算术表达式

MongoDB 4.2添加了[`$round`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/round/#mongodb-expression-exp.-round)聚合表达式。使用[`$round`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/round/#mongodb-expression-exp.-round)将数字值四舍五入到特定数字或小数位。

MongoDB 4.2为[`$trunc`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/trunc/#mongodb-expression-exp.-trunc)添加了扩展的功能和新的语法。使用带有新语法的[`$trunc`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/trunc/#mongodb-expression-exp.-trunc)将数值截断为特定数字或小数位。

#### 聚合正则表达式（正则表达式）运算符

MongoDB 4.2添加了以下正则表达式（正则表达式）模式匹配运算符，用于聚合管道：

| 运算符号                                                     | 描述                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`$regexFind`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/regexFind/#mongodb-expression-exp.-regexFind) | 将正则表达式（正则表达式）应用到字符串上，并返回*第一个*匹配子字符串上的信息。 |
| [`$regexFindAll`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/regexFindAll/#mongodb-expression-exp.-regexFindAll) | 将正则表达式（正则表达式）应用到字符串上，并返回所有匹配子字符串的信息。 |
| [`$regexMatch`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/regexMatch/#mongodb-expression-exp.-regexMatch) | 将正则表达式（正则表达式）应用到字符串，如果找到匹配项，则返回`true`，如果未找到匹配项，则返回`false`。 |

在MongoDB 4.2之前，聚合管道只能在[`$match`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/match/#mongodb-pipeline-pipe.-match)阶段使用查询操作器[`$regex`](https://www.mongodb.com/docs/upcoming/reference/operator/query/regex/#mongodb-query-op.-regex)。

#### 新阶段

MongoDB 4.2添加了以下新的聚合管道阶段：

| 新阶段                                                       | 描述                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`$merge`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge) | 将聚合结果写入集合。[`$merge`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge)阶段可以将结果（合并文档、替换文档、保留现有文档、操作失败、使用自定义更新管道处理文档）集成到现有集合中。 |
| [`$planCacheStats`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/planCacheStats/#mongodb-pipeline-pipe.-planCacheStats) | 提供集合[的计划缓存](https://www.mongodb.com/docs/upcoming/core/query-plans/)信息。与4.2中不建议使用的以下方法和命令相比，[`$planCacheStats`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/planCacheStats/#mongodb-pipeline-pipe.-planCacheStats)聚合阶段更受欢迎：`PlanCache.getPlansByQuery()`method/`planCacheListPlans`命令，以及`PlanCache.listQueryShapes()`method/`planCacheListQueryShapes`命令。 提示另见：[不建议使用的计划缓存命令/方法](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-deprecated-plan-cache) |
| [`$replaceWith`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith) | 将输入文档替换为指定的文档。该操作取代了输入文档中的所有现有字段，包括`_id`字段。新的[`$replaceWith`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith)阶段是[`$replaceRoot`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot)阶段的别名。 |
| [`$set`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set) | 向文档添加新字段。该阶段输出包含输入文档中所有现有字段以及新添加字段的文档。新的[`$set`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set)阶段是[`$addFields`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields)阶段的别名。 |
| [`$unset`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset) | 从文档中排除字段。新的[`$unset`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset)阶段是[`$project`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project)阶段的别名，不包括字段。 |

#### 新变量

MongoDB 4.2添加了以下新的聚合管道变量：

| 变量                                                         | 描述                                           |
| :----------------------------------------------------------- | :--------------------------------------------- |
| [`NOW`](https://www.mongodb.com/docs/upcoming/reference/aggregation-variables/#mongodb-variable-variable.NOW) | 返回当前日期时间值。                           |
| [`CLUSTER_TIME`](https://www.mongodb.com/docs/upcoming/reference/aggregation-variables/#mongodb-variable-variable.CLUSTER_TIME) | 返回当前时间戳值。*仅适用于复制集和分片集群。* |

#### 可用性

从MongoDB 4.2开始，您可以使用聚合管道进行更新：

| 指挥权                                                       | `mongosh`方法                                                |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`findAndModify`](https://www.mongodb.com/docs/upcoming/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify) | [db.collection.findOneAndUpdate（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.findOneAndUpdate/#std-label-findOneAndUpdate-agg-pipeline)[db.collection.findAndModify（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.findAndModify/#std-label-findAndModify-agg-pipeline) |
| [`update`](https://www.mongodb.com/docs/upcoming/reference/command/update/#mongodb-dbcommand-dbcmd.update) | [db.collection.updateOne（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.updateOne/#std-label-updateOne-example-agg)[db.collection.updateMany（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.updateMany/#std-label-updateMany-example-agg)[Bulk.find.update（）](https://www.mongodb.com/docs/upcoming/reference/method/Bulk.find.update/#std-label-example-bulk-find-update-agg)[Bulk.find.updateOne（）](https://www.mongodb.com/docs/upcoming/reference/method/Bulk.find.updateOne/#std-label-example-bulk-find-update-one-agg)[Bulk.find.upsert（）](https://www.mongodb.com/docs/upcoming/reference/method/Bulk.find.upsert/#std-label-bulk-find-upsert-update-agg-example) |

对于更新，管道可以包括以下几个阶段：

- [`$addFields`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields)及其别名[`$set`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set)
- [`$project`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project)及其别名[`$unset`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset)
- [`$replaceRoot`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot)及其别名[`$replaceWith`。](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith)

使用聚合管道可以进行更具表现力的更新语句，例如根据当前字段值表达条件更新，或使用另一个字段的值更新一个字段。

有关详细信息和示例，请参阅各个参考页面。

> 另见：
>
> - [聚合管道的更新](https://www.mongodb.com/docs/upcoming/tutorial/update-documents-with-aggregation-pipeline/)
> - [集合](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compat-agg)

### 更改流

#### `startAfter`更改流选项

MongoDB 4.2添加了`startAfter`作为[更改流的](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-changeStreams)选项，该选项在恢复令牌指示的事件后启动新的更改流。使用此选项，您可以从[无效事件](https://www.mongodb.com/docs/upcoming/reference/change-events/invalidate/#std-label-change-event-invalidate)启动更改流，从而保证在上一个流无效后不会错过通知。

#### 更改流恢复令牌

MongoDB 4.2使用版本1（即`v1`）更改流[恢复令牌](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-change-stream-resume-token)，[该令牌](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-change-stream-resume-token)在版本4.0.7中引入。

从MongoDB 4.2开始，如果[更改流聚合管道](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-change-stream-modify-output)修改事件的[_id](https://www.mongodb.com/docs/upcoming/reference/change-events/#std-label-change-stream-event-id)字段，更改流将抛出异常。

#### 可用性

从MongoDB 4.2开始，无论[`"majority"`](https://www.mongodb.com/docs/upcoming/reference/read-concern-majority/#mongodb-readconcern-readconcern.-majority-)读取关注支持如何，[更改流](https://www.mongodb.com/docs/upcoming/changeStreams/)都是可用的；也就是说，读取关注`majority`支持可以启用（默认）或[禁用以](https://www.mongodb.com/docs/upcoming/reference/read-concern-majority/#std-label-disable-read-concern-majority)使用更改流。

在MongoDB 4.0及更早版本中，只有当启用[`"majority"`](https://www.mongodb.com/docs/upcoming/reference/read-concern-majority/#mongodb-readconcern-readconcern.-majority-)读取关注支持（默认值）时，[更改流](https://www.mongodb.com/docs/upcoming/changeStreams/)才可用。

#### 更改流管道

从MongoDB 4.2开始，您可以使用[更改流聚合管道](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-change-stream-modify-output)中的其他阶段来修改更改流输出（即事件文档）：

- [`$replaceWith`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith)
- [`$set`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set)
- [`$unset`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset)

从MongoDB 4.2开始，如果[更改流聚合管道](https://www.mongodb.com/docs/upcoming/changeStreams/#std-label-change-stream-modify-output)修改事件的[_id](https://www.mongodb.com/docs/upcoming/reference/change-events/#std-label-change-stream-event-id)字段，更改流将抛出异常。

> 另见：
>
> [更改流兼容性更改](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compatibility-change-streams)

### 更新增强功能

从MongoDB 4.2开始，您可以使用聚合管道进行更新：

| 指挥权                                                       | `mongosh`方法                                                |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`findAndModify`](https://www.mongodb.com/docs/upcoming/reference/command/findAndModify/#mongodb-dbcommand-dbcmd.findAndModify) | [db.collection.findOneAndUpdate（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.findOneAndUpdate/#std-label-findOneAndUpdate-agg-pipeline)[db.collection.findAndModify（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.findAndModify/#std-label-findAndModify-agg-pipeline) |
| [`update`](https://www.mongodb.com/docs/upcoming/reference/command/update/#mongodb-dbcommand-dbcmd.update) | [db.collection.updateOne（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.updateOne/#std-label-updateOne-example-agg)[db.collection.updateMany（）](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.updateMany/#std-label-updateMany-example-agg)[Bulk.find.update（）](https://www.mongodb.com/docs/upcoming/reference/method/Bulk.find.update/#std-label-example-bulk-find-update-agg)[Bulk.find.updateOne（）](https://www.mongodb.com/docs/upcoming/reference/method/Bulk.find.updateOne/#std-label-example-bulk-find-update-one-agg)[Bulk.find.upsert（）](https://www.mongodb.com/docs/upcoming/reference/method/Bulk.find.upsert/#std-label-bulk-find-upsert-update-agg-example) |

对于更新，管道可以包括以下几个阶段：

- [`$addFields`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/addFields/#mongodb-pipeline-pipe.-addFields)及其别名[`$set`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/set/#mongodb-pipeline-pipe.-set)
- [`$project`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/project/#mongodb-pipeline-pipe.-project)及其别名[`$unset`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/unset/#mongodb-pipeline-pipe.-unset)
- [`$replaceRoot`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceRoot/#mongodb-pipeline-pipe.-replaceRoot)及其别名[`$replaceWith`。](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/replaceWith/#mongodb-pipeline-pipe.-replaceWith)

使用聚合管道可以进行更具表现力的更新语句，例如根据当前字段值表达条件更新，或使用另一个字段的值更新一个字段。

有关详细信息和示例，请参阅各个参考页面。

#### 更新和提

从MongoDB 4.2开始,  [`update`](https://www.mongodb.com/docs/upcoming/reference/command/update/#mongodb-dbcommand-dbcmd.update)命令和相关的mongo shell方法 [`db.collection.update()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.update/#mongodb-method-db.collection.update)可以接受一个hint参数来指定要使用的索引。见

- [`update`](https://www.mongodb.com/docs/upcoming/reference/command/update/#mongodb-dbcommand-dbcmd.update)
- [`db.collection.update()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.update/#mongodb-method-db.collection.update)

#### 分片收集和替换文档

从MongoDB 4.2开始

* 替换文档的操作，如 [`replaceOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne)或[`update()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.update/#mongodb-method-db.collection.update) () (当与替换文档一起使 用时),将首先尝试使用查询过滤器以单个碎片为目标。如果该操作无法通 过查询筛选器定位单个碎片，则尝试通过替换文档定位。在早期版本中，这 些操作仅尝试使用替换文档定位。
* 不建议使用`save()`方法：改用[`insertOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.insertOne/#mongodb-method-db.collection.insertOne)或[`replaceOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.replaceOne/#mongodb-method-db.collection.replaceOne)方法。`save()`方法不能与`_id`*未*分片的分片集合一起使用，尝试这样做将导致错误。
* 对于包含`upsert: true`且在分片集合上的替换文档操作，`filter`必须在全分片键上包含相等匹配。

### 通配符索引

MongoDB 4.2引入了[通配符索引](https://www.mongodb.com/docs/upcoming/core/index-wildcard/#std-label-wildcard-index-core)，用于支持对名称未知或任意的字段的查询。

考虑一个在`userMetadata`字段下捕获用户定义数据并支持对该数据进行查询的应用程序：

```shell
{ "userMetadata" : { "likes" : [ "dogs", "cats" ] } }
{ "userMetadata" : { "dislikes" : "pickles" } }
{ "userMetadata" : { "age" : 45 } }
{ "userMetadata" : "inactive" }
```

管理员希望创建索引来支持`userMetadata`任何子字段上的查询。

`userMetadata`上的通配符索引可以支持`userMetadata`、`userMetadata.likes`、`userMetadata.dislikes`和`userMetadata.age`单字段查询：

```shell
db.userData.createIndex( { "userMetadata.$**" : 1 } )
```

该索引可以支持以下查询：

```shell
db.userData.find({ "userMetadata.likes" : "dogs" })
db.userData.find({ "userMetadata.dislikes" : "pickles" })
db.userData.find({ "userMetadata.age" : { $gt : 30 } })
db.userData.find({ "userMetadata" : "inactive" })
```

`userMetadata`上的非通配符索引只能支持对`userMetadata`值的查询。

> 重要：
>
> 通配符索引不是为了取代基于工作负载的索引规划而设计的。有关创建索引以支持查询的更多信息，请参阅[创建索引以支持您的查询](https://www.mongodb.com/docs/upcoming/tutorial/create-indexes-to-support-queries/#std-label-create-indexes-to-support-queries)。有关通配符索引限制的完整文档，请参阅[符卡索引限制。](https://www.mongodb.com/docs/upcoming/reference/index-wildcard-restrictions/#std-label-wildcard-index-restrictions)

[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)[功能CompatibilityVersion](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)必须为4.2才能创建通配符索引。有关设置fCV的说明，请参阅[MongoDB 6.0部署上的设置功能兼容性版本。](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-set-fcv)

您可以使用[`createIndexes`](https://www.mongodb.com/docs/upcoming/reference/command/createIndexes/#mongodb-dbcommand-dbcmd.createIndexes)数据库命令或其shell助手[`db.collection.createIndex()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndex/#mongodb-method-db.collection.createIndex)和[`db.collection.createIndexes()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndexes/#mongodb-method-db.collection.createIndexes)创建通配符索引。有关创建通配符索引的示例，请参阅[创建通配符索引。](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndex/#std-label-createIndex-method-wildcard-examples)

有关完整的文档，请参阅[通配符索引](https://www.mongodb.com/docs/upcoming/core/index-wildcard/#std-label-wildcard-index-core)。

### 平台支持

- MongoDB 4.2增加了对以下内容的支持：
  - ARM64上的Ubuntu 18.04
- MongoDB 4.2取消了对以下内容的支持：
  - Debian 8
  - Ubuntu14.04
  - Ubuntu 16.04 ARM64 for MongoDB社区版
  - Ubuntu 16.04 POWER/PPC64LE（也在3.6.13和3.4.21版本中删除）
  - macOS 10.11

### MongoDB工具

### FIPS模式

从4.2版本开始，MongoDB删除了以下程序的`--sslFIPSMode`选项：

- [`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)
- [`mongoexport`](https://www.mongodb.com/docs/database-tools/mongoexport/#mongodb-binary-bin.mongoexport)
- [`mongofiles`](https://www.mongodb.com/docs/database-tools/mongofiles/#mongodb-binary-bin.mongofiles)
- [`mongoimport`](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport)
- [`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)
- [`mongostat`](https://www.mongodb.com/docs/database-tools/mongostat/#mongodb-binary-bin.mongostat)
- [`mongotop`](https://www.mongodb.com/docs/database-tools/mongotop/#mongodb-binary-bin.mongotop)

如果 [`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) / [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)实例被配置为使用FIPS模式，则程序将使用与  [`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) / [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)兼容的FIPS连接。

#### `--uri`选项

从4.2版本开始

- 对于以下数据库工具，如果在`--uri`连接字符串和`--writeConcern`选项中都指定了写入问题，`--writeConcern`选项将覆盖连接字符串中的选项：
  - [`mongofiles`](https://www.mongodb.com/docs/database-tools/mongofiles/#mongodb-binary-bin.mongofiles)
  - [`mongoimport`](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport)
  - [`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)
- 对于以下数据库工具，如果在`--uri`连接字符串和`--readPreference`选项中都指定了读取首选项，则`--readPreference`选项将覆盖连接字符串中的选项：
  - [`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)
  - [`mongoexport`](https://www.mongodb.com/docs/database-tools/mongoexport/#mongodb-binary-bin.mongoexport)
  - [`mongofiles`](https://www.mongodb.com/docs/database-tools/mongofiles/#mongodb-binary-bin.mongofiles)

#### 扩展JSON v2

从4.2版本开始：

| 二进制                                                       | 变化                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`bsondump`](https://www.mongodb.com/docs/database-tools/bsondump/#mongodb-binary-bin.bsondump) | 使用扩展JSON v2.0（规范模式）格式。                          |
| [`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump) | 对元数据使用扩展JSON v2.0（规范模式）格式。需要[`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)支持扩展JSON v2.0（规范模式或放松模式）格式的4.2或更高版本。   提示：一般来说，使用相应的版本[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)和[`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)。也就是说，恢复使用特定版本创建的数据文件[`mongodump`](https://www.mongodb.com/docs/database-tools/mongodump/#mongodb-binary-bin.mongodump)，使用相应的版本[`mongorestore`。](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore) |
| [`mongoexport`](https://www.mongodb.com/docs/database-tools/mongoexport/#mongodb-binary-bin.mongoexport) | 默认情况下，在扩展JSON v2.0（放松模式）中创建输出数据。如果与`--jsonFormat`一起使用，则在扩展JSON v2.0（规范模式）中创建输出数据。 |
| [`mongoimport`](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport) | 默认情况下，预计导入数据处于扩展JSON v2.0（放松模式或规范模式）。如果指定了选项`--legacy`，可以识别扩展JSON v1.0格式的数据。     提示：一般来说，版本[`mongoexport`](https://www.mongodb.com/docs/database-tools/mongoexport/#mongodb-binary-bin.mongoexport)和[`mongoimport`](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport)应该匹配。也就是说，导入从[`mongoexport`](https://www.mongodb.com/docs/database-tools/mongoexport/#mongodb-binary-bin.mongoexport)，您应该使用相应的版本[`mongoimport`。](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport) |

有关MongoDB扩展JSON v2的详细信息，请参阅[MongoDB扩展JSON（v2）。](https://www.mongodb.com/docs/upcoming/reference/mongodb-extended-json/)

>另见：
>
>[`--query`选项](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compatibility-v2-query)

#### `mongofiles`

这个[`mongofiles`](https://www.mongodb.com/docs/database-tools/mongofiles/#mongodb-binary-bin.mongofiles)命令`get_id`和`delete_id`可以接受`_id`的ObjectId或非ObjectId值。

#### `mongoimport`和`mongorestore`

##### `mongoimport`

从4.2版本开始：

- [`mongoimport`](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport)使用最大批处理大小为100,000来执行批量插入/插入操作。
- [`mongoimport`](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport)默认情况下，当它遇到重复的密钥和文档验证错误时，请继续。为了确保程序停止这些错误，请指定`--stopOnError`。
- 指定`--maintainInsertionOrder`[`mongoimport`：](https://www.mongodb.com/docs/database-tools/mongoimport/#mongodb-binary-bin.mongoimport)
  - 使用有序的批量写入操作维护文档插入顺序；即维护批处理中的批处理顺序和文档顺序。在早期版本中，仅维护批处理顺序；批处理中的文档顺序不维护。
  - 启用`--stopOnError`，并将`numInsertionWorkers`设置为1。

##### `mongorestore`

从4.2版本开始：

- [`mongorestore`](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)默认情况下，当它遇到重复的密钥和文档验证错误时，请继续。为了确保程序停止这些错误，请指定`--stopOnError`。
- 指定`--maintainInsertionOrder`[`mongorestore`：](https://www.mongodb.com/docs/database-tools/mongorestore/#mongodb-binary-bin.mongorestore)
  - 使用有序的批量写入操作维护文档插入顺序；即维护批处理中的批处理顺序和文档顺序。在早期版本中，仅维护批处理顺序；批处理中的文档顺序不维护。
  - 启用`--stopOnError`并将`--numInsertionWorkersPerCollection`设置为1。

#### 特定DDL操作的锁定优化

从MongoDB 4.2开始，以下操作采用独家收集锁，而不是独家数据库锁：

| 命令                                                         | 方法                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`create`](https://www.mongodb.com/docs/upcoming/reference/command/create/#mongodb-dbcommand-dbcmd.create) | [`db.createCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/db.createCollection/#mongodb-method-db.createCollection)[`db.createView()`](https://www.mongodb.com/docs/upcoming/reference/method/db.createView/#mongodb-method-db.createView) |
| [`createIndexes`](https://www.mongodb.com/docs/upcoming/reference/command/createIndexes/#mongodb-dbcommand-dbcmd.createIndexes) | [`db.collection.createIndex()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndex/#mongodb-method-db.collection.createIndex)[`db.collection.createIndexes()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndexes/#mongodb-method-db.collection.createIndexes) |
| [`drop`](https://www.mongodb.com/docs/upcoming/reference/command/drop/#mongodb-dbcommand-dbcmd.drop) | [`db.collection.drop()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.drop/#mongodb-method-db.collection.drop) |
| [`dropIndexes`](https://www.mongodb.com/docs/upcoming/reference/command/dropIndexes/#mongodb-dbcommand-dbcmd.dropIndexes) | [`db.collection.dropIndex()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.dropIndex/#mongodb-method-db.collection.dropIndex)[`db.collection.dropIndexes()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.dropIndexes/#mongodb-method-db.collection.dropIndexes) |
| [`renameCollection`](https://www.mongodb.com/docs/upcoming/reference/command/renameCollection/#mongodb-dbcommand-dbcmd.renameCollection) | [`db.collection.renameCollection()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.renameCollection/#mongodb-method-db.collection.renameCollection) |

在MongoDB 4.2之前，这些操作对数据库进行了独家锁定，在操作完成之前阻止数据库及其收集上的所有操作。



在早期版本中，`get_id`和`delete_id`只能接受`_id`的ObjectId值。

### 监视

从4.2版本开始，[存储节点监视器](https://www.mongodb.com/docs/upcoming/administration/monitoring/#std-label-storage-node-watchdog)有MongoDB社区版和MongoDB企业版。

在早期版本中，该功能仅在MongoDB Enterpriseedition中可用。

### 流量控制

MongoDB 4.2引入了一种流量控制机制，以控制主服务器应用写入的速度，从而将[`majority committed`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.lastCommittedOpTime)保持在指定的最大值下。

默认情况下[`enabled`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.enableFlowControl)流量控制。

>笔记：
>
>要进行流控制，副本集/分片群集必须具有:  [featureCompatibilityVersion (FCV)](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)为4.2并且读取关注多数启用 。也就是说，如果FCV不是4.2或如果读关注多数被禁用，则启用的 流控制没有效果。

有关更多信息，请参阅[复制滞后和流量控制。](https://www.mongodb.com/docs/upcoming/replication/#std-label-replication-flow-control)

### 记录和诊断

#### 记录

- 在日志消息中添加了[`INITSYNC`](https://www.mongodb.com/docs/upcoming/reference/log-messages/#mongodb-data-INITSYNC)组件。

- 在日志消息中添加了[`ELECTION`](https://www.mongodb.com/docs/upcoming/reference/log-messages/#mongodb-data-ELECTION)组件。

- 对于调试消息，包括详细级别（即D 【1-5】)。例如，如果详细级 别为2, MongoDB记录D2。在以前的版本中, MongoDB日志消息 只指定D作为Debug级别。

- 登录[`syslog`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--syslog)时，消息文本的格式包括[组件](https://www.mongodb.com/docs/upcoming/reference/log-messages/#std-label-log-message-components)。例如：

  ```shell
  ...  ACCESS   [repl writer worker 5] Unsupported modification to roles collection ...
  ```

  以前，[`syslog`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--syslog)消息文本不包括该组件。例如：

  ```shell
  ... [repl writer worker 1] Unsupported modification to roles collection ...
  ```

- MongoDB 4.2为聚合操作的探查器日志消息和诊断日志消息添加了一个usedDisk指示器。usedDisk指示聚合操作的任何阶段是否由于内存限制而将数据写入临时文件。有关聚合内存限制的详细信息，请参阅[Memory Restrictions。](https://www.mongodb.com/docs/upcoming/core/aggregation-pipeline-limits/#std-label-agg-memory-restrictions)。

- 从4.2版本开始（也从4.0.6开始可用），副本集的次要成员现在记录需要超过慢操作阈值才能应用的操作操作时间更长的操作条目。这些消息在[`REPL`](https://www.mongodb.com/docs/upcoming/reference/log-messages/#mongodb-data-REPL)组件下为次要[`logged`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--logpath)，文本`applied op: <oplog entry> took <num>ms`。

  ```shell
  2018-11-16T12:31:35.886-0500 I REPL   [repl writer worker 13] applied op: command { ... }, took 112ms
  ```

  二级应用程序日志的缓慢操作日志应用程序日志是：

- * 不受slowOpSampleRate的影响；即所有缓慢的操作日志条目都由辅助部分记录。
  * 不受[`logLevel`/](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.logLevel)[`systemLog.verbosity`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-systemLog.verbosity)级别（或[`systemLog.component.replication.verbosity`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-systemLog.component.replication.verbosity)级别）的影响；即对于oplog条目，辅助日志仅受缓慢的oplog条目的影响。提高详细程度不会记录所有oplog条目。
  * 未被[分析器](https://www.mongodb.com/docs/upcoming/tutorial/manage-the-database-profiler/)捕获，也不受剖析级别的影响。

  有关设置慢操作阈值的更多信息，请参阅

- * [`mongod --slowms`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--slowms)
  * [`slowOpThresholdMs`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-operationProfiling.slowOpThresholdMs)
  * 从 [`profile`](https://www.mongodb.com/docs/upcoming/reference/command/profile/#mongodb-dbcommand-dbcmd.profile) 命令或 [`db.setProfilingLevel()`](https://www.mongodb.com/docs/upcoming/reference/method/db.setProfilingLevel/#mongodb-method-db.setProfilingLevel) shell 帮助器方法

- 从MongoDB 4.2开始，[`getLog`](https://www.mongodb.com/docs/upcoming/reference/command/getLog/#mongodb-dbcommand-dbcmd.getLog)命令截断任何包含超过1024个字符的事件。在早期版本中，[`getLog`](https://www.mongodb.com/docs/upcoming/reference/command/getLog/#mongodb-dbcommand-dbcmd.getLog)512个字符后截断。

- 从MongoDB 4.2（和4.0.9开始），对于缓慢的操作，[分析器条目](https://www.mongodb.com/docs/upcoming/tutorial/manage-the-database-profiler/)和[诊断日志消息](https://www.mongodb.com/docs/upcoming/reference/log-messages/)包括[`storage`](https://www.mongodb.com/docs/upcoming/reference/database-profiler/#mongodb-data-system.profile.storage)信息。

- 从MongoDB 4.2开始，用于读/写操作的[分析器条目](https://www.mongodb.com/docs/upcoming/tutorial/manage-the-database-profiler/)和[诊断日志消息（即mongod/mongos日志消息）](https://www.mongodb.com/docs/upcoming/reference/log-messages/#std-label-log-message-slow-ops)包括：

  - `queryHash`帮助识别具有相同[查询形状](https://www.mongodb.com/docs/upcoming/reference/glossary/#std-term-query-shape)的缓慢查询[。](https://www.mongodb.com/docs/upcoming/reference/glossary/#std-term-query-shape)
  - `planCacheKey`更深入地了解缓慢查询的[查询计划缓存](https://www.mongodb.com/docs/upcoming/core/query-plans/)。

  看[查询计划改进。](https://www.mongodb.com/docs/upcoming/release-notes/4.2/#std-label-4.2-query-plans)

#### `currentOp`

MongoDB 4.2在[`$currentOp`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-pipeline-pipe.-currentOp)聚合阶段添加了一个新的选项`idleCursors`，以返回空闲光标上的信息。

此外，MongoDB 4.2向从[`$currentOp`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-pipeline-pipe.-currentOp)聚合阶段、[`currentOp`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-dbcommand-dbcmd.currentOp)命令和[`db.currentOp()`](https://www.mongodb.com/docs/upcoming/reference/method/db.currentOp/#mongodb-method-db.currentOp)帮助程序返回的文档中添加了以下新字段：

| `$currentOp`                                                 | `currentOp`/`db.currentOp()`                                 | 描述                                                     |
| :----------------------------------------------------------- | :----------------------------------------------------------- | :------------------------------------------------------- |
| [`$currentOp.type`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-data--currentOp.type) | [`currentOp.type`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-data-currentOp.type) | 指定报告的操作是否为`op`、`idleSession`、oridleCursor。  |
| [`$currentOp.cursor`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-data--currentOp.cursor) | [`currentOp.cursor`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-data-currentOp.cursor) | 指定光标详细信息。返回`getmore`oridleCursor信息时可用。  |
| [`$currentOp.effectiveUsers`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-data--currentOp.effectiveUsers) | [`currentOp.effectiveUsers`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-data-currentOp.effectiveUsers) | 指定与操作关联的用户。                                   |
| [`$currentOp.prepareReadConflicts`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-data--currentOp.prepareReadConflicts) | [`currentOp.prepareReadConflicts`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-data-currentOp.prepareReadConflicts) | 指定当前操作必须等待带有写入提交或中止的准备事务的次数。 |
| [`$currentOp.runBy`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-data--currentOp.runBy) | [`currentOp.runBy`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-data-currentOp.runBy) | 指定正在为操作模拟有效用户的用户。                       |
| [`$currentOp.writeConflicts`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-data--currentOp.writeConflicts) | [`currentOp.writeConflicts`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-data-currentOp.writeConflicts) | 指定当前操作与另一个写入操作冲突的次数。                 |

参见：[4.2当前操作兼容性更改](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-current-op-compat)

#### `serverStatus`度量

从MongoDB 4.2开始, [`serverStatus`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-dbcommand-dbcmd.serverStatus)命令和mongo shell法 [`db.serverStatus()`](https://www.mongodb.com/docs/upcoming/reference/method/db.serverStatus/#mongodb-method-db.serverStatus) 包括以下输出更改

| 更新了                                                       | 变化                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| [`shardingStatistics`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics) | 添加了新字段：[`shardingStatistics.countDocsClonedOnRecipient`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics.countDocsClonedOnRecipient)[`shardingStatistics.countDocsClonedOnDonor`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics.countDocsClonedOnDonor)[`shardingStatistics.countDocsDeletedOnDonor`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics.countDocsDeletedOnDonor)[`shardingStatistics.countRecipientMoveChunkStarted`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics.countRecipientMoveChunkStarted)[`shardingStatistics.countDonorMoveChunkLockTimeout`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.shardingStatistics.countDonorMoveChunkLockTimeout) |
| [`metrics.repl.network`：](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl.network) | 添加了新字段：[`metrics.repl.network.notMasterLegacyUnacknowledgedWrites`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl.network.notPrimaryLegacyUnacknowledgedWrites)[`metrics.repl.network.notMasterUnacknowledgedWrites`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl.network.notPrimaryUnacknowledgedWrites) |
| [`metrics.repl`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl) | 添加了新的[`metrics.repl.stepDown`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl.stepDown)指标：[`metrics.repl.stepDown.userOperationsKilled`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl.stepDown.userOperationsKilled)[`metrics.repl.stepDown.userOperationsRunning`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.metrics.repl.stepDown.userOperationsRunning) |
| [`transactions`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.transactions) | 现在可用于[`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)（以前仅适用于[`mongod`）](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)添加了[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)实例的新字段：[`transactions.totalPrepared`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.transactions.totalPrepared)[`transactions.totalPreparedThenCommitted`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.transactions.totalPreparedThenCommitted)[`transactions.totalPreparedThenAborted`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.transactions.totalPreparedThenAborted)[`transactions.currentPrepared`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.transactions.currentPrepared) |
| [`logicalSessionRecordCache`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.logicalSessionRecordCache) | 添加了新字段[`logicalSessionRecordCache.sessionCatalogSize`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.logicalSessionRecordCache.sessionCatalogSize) |
| [`locks`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-serverstatus-serverstatus.locks) | 将`ParallelBatchWriterMode`与`Global`锁定信息分开。添加`ReplicationStateTransition`锁定信息。 |

#### 副本集状态指标

Starting in version MongoDB 4.2, [`replSetGetStatus`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-dbcommand-dbcmd.replSetGetStatus) and its `mongo` shell helper [`rs.status()`](https://www.mongodb.com/docs/upcoming/reference/method/rs.status/#mongodb-method-rs.status) return:

- 副本集成员的IP地址[`replSetGetStatus.members[n\].ip`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.members-n-.ip)。

- ISODate格式的日期字符串字段，对应于各种[`replSetGetStatus.optimes`。](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes)

  | 新的ISODate格式日期字符串字段                                | 相应的 Optime 字段                                           |
  | :----------------------------------------------------------- | :----------------------------------------------------------- |
  | [`lastCommittedWallTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.lastCommittedWallTime) | [`lastCommittedOpTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.lastCommittedOpTime) |
  | [`readConcernMajorityWallTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.readConcernMajorityWallTime) | [`readConcernMajorityOpTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.readConcernMajorityOpTime) |
  | [`lastAppliedWallTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.lastAppliedWallTime) | [`appliedOpTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.appliedOpTime) |
  | [`lastDurableWallTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.lastDurableWallTime) | [`durableOpTime`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.optimes.durableOpTime) |

MongoDB 4.2不建议使用[`lastStableCheckpointTimestamp`](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.lastStableCheckpointTimestamp)字段[。](https://www.mongodb.com/docs/upcoming/reference/command/replSetGetStatus/#mongodb-data-replSetGetStatus.lastStableCheckpointTimestamp)

#### 锁定诊断报告

从4.2版本开始，MongoDB报告`ReplicationStateTransition`锁定信息。

此外，MongoDB 4.2将`ParallelBatchWriterMode`锁信息与`Global`锁信息分开。早期的MongoDB版本将`ParallelBatchWriterMode`锁定信息作为`Global`锁的一部分。

有关报告锁定信息的操作，请参阅：

- [`serverStatus`](https://www.mongodb.com/docs/upcoming/reference/command/serverStatus/#mongodb-dbcommand-dbcmd.serverStatus)命令和[`db.serverStatus()`](https://www.mongodb.com/docs/upcoming/reference/method/db.serverStatus/#mongodb-method-db.serverStatus)方法。
- [`$currentOp`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/currentOp/#mongodb-pipeline-pipe.-currentOp)聚合管道阶段、[`currentOp`](https://www.mongodb.com/docs/upcoming/reference/command/currentOp/#mongodb-dbcommand-dbcmd.currentOp)命令和[`db.currentOp()`](https://www.mongodb.com/docs/upcoming/reference/method/db.currentOp/#mongodb-method-db.currentOp)方法。

#### `collStats`改进

从MongoDB 4.2开始，[`$collStats`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/collStats/#mongodb-pipeline-pipe.-collStats)聚合、 [`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)命令和`mongo` shell helper [`db.collection.stats（）`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.stats/#mongodb-method-db.collection.stats)返回有关索引信息，这些信息 正在建造中。

有关详细信息，请参阅：

- [`collStats.nindexes`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-data-collStats.nindexes)
- [`collStats.indexDetails`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-data-collStats.indexDetails)
- [`collStats.indexBuilds`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-data-collStats.indexBuilds)
- [`collStats.totalIndexSize`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-data-collStats.totalIndexSize)
- [`collStats.indexSizes`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-data-collStats.indexSizes)

从MongoDB 4.2开始，[`$collStats`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/collStats/#mongodb-pipeline-pipe.-collStats)聚合，则 [`collStats`](https://www.mongodb.com/docs/upcoming/reference/command/collStats/#mongodb-dbcommand-dbcmd.collStats)命令，然后使用`蒙戈`壳 助手[`数据库集合统计信息（）`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.stats/#mongodb-method-db.collection.stats)退回`比例因子`习惯 缩放各种尺寸的数据。

#### `dbStats`改进

从MongoDB 4.2开始，[`数据库统计`](https://www.mongodb.com/docs/upcoming/reference/command/dbStats/#mongodb-dbcommand-dbcmd.dbStats)命令，然后使用 `蒙戈`外壳辅助程序[`数据库统计信息（）`](https://www.mongodb.com/docs/upcoming/reference/method/db.stats/#mongodb-method-db.stats)返回 该`比例因子`用于缩放各种尺寸数据。

### 一般改进

#### 配置文件的外部来源值

MongoDB支持使用 [扩展指令](https://www.mongodb.com/docs/upcoming/reference/expansion-directives/#std-label-expansion-directives)配置中 文件以加载外部来源的值。扩展指令可以 特定负载值 [配置文件选项](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#std-label-configuration-options)*或*加载 整个配置文件。

以下扩展指令可用：

| 扩张指令                                                     | 说明                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`__rest`](https://www.mongodb.com/docs/upcoming/reference/expansion-directives/#mongodb-configexpansion-configexpansion.__rest) | 允许用户指定 `REST` 端点作为外部源 用于配置文件选项 *或* 完整的配置文件。 |
| [`__exec`](https://www.mongodb.com/docs/upcoming/reference/expansion-directives/#mongodb-configexpansion-configexpansion.__exec) | 允许用户将shell或terminal命令指定为 配置文件选项的外部源 *或* 该 完整配置文件。 |

有关完整文档，请参见[外部来源配置文件值。](https://www.mongodb.com/docs/upcoming/reference/expansion-directives/#std-label-externally-sourced-values)

#### `输出配置`选项

MongoDB 4.2添加了 [`--outputConfig`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#std-option-mongod.--outputConfig)选项，用于mongod和mongos的选项，该备选办法输出到标准输出mongod / mongos实例的配置，采用YAML格式。

如果配置使用任何[外部来源的配置文件值](https://www.mongodb.com/docs/upcoming/reference/expansion-directives/#std-label-externally-sourced-values)，则 选项返回这些选项的解析值。

>警告：
>
>这可能包括之前配置的任何密码或密码 通过外部来源混淆。

有关用法示例，请参见：

- [输出包含已解析的扩展指令值的配置文件](https://www.mongodb.com/docs/upcoming/reference/expansion-directives/#std-label-expansion-directive-output)
- [将命令行选项转换为YAML](https://www.mongodb.com/docs/upcoming/tutorial/convert-command-line-options-to-yaml/)

#### 删除索引键大小限制

从MongoDB 4.2开始，用于[功能兼容性版本](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)设为`"4.2"`或更高，MongoDB将删除 [索引键限制](https://www.mongodb.com/docs/upcoming/reference/limits/#mongodb-limit-Index-Key-Limit)。对于fCV设置为`"4.0"`，极限依旧 适用。

> 另见：
>
> [4.2索引兼容性更改](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-index-compat-changes)

#### 删除索引名称长度限制

从版本4.2开始，对于设置为“4.2”或更高版本的 [featureCompatibilityVersion](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)，MongoDB删除了最大127字节的索引名称长度限制。在以前 版本或MongoDB版本featureCompatibilityVersion（fCV）设置为“4.0”，则索引名称必须在

> 另见：
>
> [4.2索引兼容性更改](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-index-compat-changes)
>
> [4.2功能兼容性](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-compatibility-enabled)

#### 改进`删除索引`

##### 删除多个索引

从MongoDB 4.2开始，您可以为 [`dropIndexes`](https://www.mongodb.com/docs/upcoming/reference/command/dropIndexes/#mongodb-dbcommand-dbcmd.dropIndexes) 命令及其mongo shell助手 [`db.collection.dropIndexes()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.dropIndexes/#mongodb-method-db.collection.dropIndexes).指定多个 要删除的索引，请将索引名称数组传递给 [`dropIndexes`/](https://www.mongodb.com/docs/upcoming/reference/command/dropIndexes/#mongodb-dbcommand-dbcmd.dropIndexes)[`db.collection.dropIndexes()`. ](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.dropIndexes/#mongodb-method-db.collection.dropIndexes)

#### 仅终止相关查询

从MongoDB 4.2开始  [`dropIndexes`](https://www.mongodb.com/docs/upcoming/reference/command/dropIndexes/#mongodb-dbcommand-dbcmd.dropIndexes) 或其shell辅助程序 [`dropIndex()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.dropIndex/#mongodb-method-db.collection.dropIndex) 以及 [`dropIndexes()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.dropIndexes/#mongodb-method-db.collection.dropIndexes) 操作只会杀死 正在使用要删除的索引的查询。这可能包括 查询将索引视为 [查询规划。](https://www.mongodb.com/docs/upcoming/core/query-plans/#std-label-query-plans-query-optimization)

在MongoDB4.2之前，删除一个 集合将终止该集合上所有打开的查询。

### `zstd`可用性

从版本4.2开始，MongoDB支持zstd

* 块压缩。见[`storage.wiredTiger.collectionConfig.blockCompressor`.](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.wiredTiger.collectionConfig.blockCompressor)
* 日志压缩。见[`storage.wiredTiger.engineConfig.journalCompressor`.](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.wiredTiger.engineConfig.journalCompressor)
* 网络压缩。见[`net.compression.compressors`.](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-net.compression.compressors)
  * 对于使用MongoDB驱动程序的客户端，它们必须使用针对MongoDB 4.2更新的驱动程序。
  * mongod和mongos的网络压缩器默认为snappy、zstd和zlib压缩器，按此顺序排列。在4.0版本中，mongod和mongos默认启用网络压缩，snappy作为压缩器。

#### 事务内部的bulkWrite（）错误处理

从MongoDB 4.2开始，如果 [`db.collection.bulkWrite()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.bulkWrite/#mongodb-method-db.collection.bulkWrite)操作在事务内部遇到错误，该方法将抛出BulkWriteException（与事务外部相同）。

在4.0中，如果`bulkWrite`操作在 事务时，引发的错误不会包装为 `批量写入异常`。

在事务内，大容量写入中的第一个错误将导致 整个大容量写入失败并中止事务，即使 批量写入是无序的。

### 查询计划改进

#### 计划缓存状态

从MongoDB 4.2开始，该高速缓存条目与一个状态相关联：

- [Missing](https://www.mongodb.com/docs/upcoming/core/query-plans/#std-label-cache-entry-missing)
- [Inactive](https://www.mongodb.com/docs/upcoming/core/query-plans/#std-label-cache-entry-inactive)
- [Active](https://www.mongodb.com/docs/upcoming/core/query-plans/#std-label-cache-entry-active)

将状态与条目相关联有助于减少以下情况的可能性 次优高速缓存条目保留在高速缓存中。如需了解更多信息， see [Query Plans。](https://www.mongodb.com/docs/upcoming/core/query-plans/)

#### `查询哈希`和`计划缓存密钥`

* `queryHash`

  ​    以帮助识别具有相同 [查询形状](https://www.mongodb.com/docs/upcoming/reference/glossary/#std-term-query-shape)， 从MongoDB 4.2开始，每个 [查询形状](https://www.mongodb.com/docs/upcoming/reference/glossary/#std-term-query-shape) 关联于 项目a [查询散列](https://www.mongodb.com/docs/upcoming/release-notes/4.2/#std-label-4.2-query-hash)。该 `queryHash` 是一个 一个十六进制字符串，表示查询形状的哈希，并 仅取决于查询形状。

  >与任何散列函数一样，可能会产生两种不同的查询形状 在同一个散列值中。但是，散列的出现 不同查询形状之间的冲突是不可能的。

* `planCacheKey`

     为了更深入地了解[查询计划缓存](https://www.mongodb.com/docs/upcoming/core/query-plans/)，MongoDB4.2引入了[planCacheKey。](https://www.mongodb.com/docs/upcoming/release-notes/4.2/#std-label-4.2-plan-cache-key)

  `planCacheKey`是计划缓存条目的键的散列 与该查询相关联。

  >与queryHash不同，planCacheKey是查询形状和形状的当前可用索引的函数。也就是说，如果添加/删除可以支持查询形状的索引，则planCacheKey值可能改变，而queryHash值将不改变。

  > 另见：
  >
  > [`计划缓存密钥`](https://www.mongodb.com/docs/upcoming/core/query-plans/#std-label-plan-cache-key)

* 该`查询散列`以及`计划缓存密钥`提供

  * [剖析器项目](https://www.mongodb.com/docs/upcoming/tutorial/manage-the-database-profiler/) 字段[`查询哈希`](https://www.mongodb.com/docs/upcoming/reference/database-profiler/#mongodb-data-system.profile.queryHash)和 [`planCacheKey`](https://www.mongodb.com/docs/upcoming/reference/database-profiler/#mongodb-data-system.profile.planCacheKey)记录的查询操作。
  * [诊断日志消息（即mongod/mongos日志 消息）](https://www.mongodb.com/docs/upcoming/reference/log-messages/#std-label-log-message-slow-ops)以用于记录的查询操作。
  * [explain（）输出](https://www.mongodb.com/docs/upcoming/reference/explain-results/)字段： [`查询哈希`](https://www.mongodb.com/docs/upcoming/reference/explain-results/#mongodb-data-explain.queryPlanner.queryHash)和 [`计划缓存密钥`](https://www.mongodb.com/docs/upcoming/reference/explain-results/#mongodb-data-explain.queryPlanner.planCacheKey)

这些字段也可用于返回信息的操作 关于查询计划高速缓存：

* [`$planCacheStats`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/planCacheStats/#mongodb-pipeline-pipe.-planCacheStats)聚合阶段（*MongoDB 4.2中的新增功能*）
* planCacheListQueryShapes（）方法/planCacheListQueryShapes命令（在MongoDB 4.2中已弃用）
* 方法/计划缓存列表计划命令（在MongoDB 4.2中已弃用）

> 另见：
>
> [弃用的计划缓存命令/方法](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/#std-label-4.2-deprecated-plan-cache)

#### `$regex`和`$not`

从MongoDB 4.2（和4.0.7）开始，[`$未`](https://www.mongodb.com/docs/upcoming/reference/operator/query/not/#mongodb-query-op.-not)运算符可以执行逻辑 `非`操作于[`$正则表达式`](https://www.mongodb.com/docs/upcoming/reference/operator/query/regex/#mongodb-query-op.-regex)运算符表达式以及 正则表达式对象（即`/模式/`）.

在4.0及更早版本中，可以将[`$not`](https://www.mongodb.com/docs/upcoming/reference/operator/query/not/#mongodb-query-op.-not)运算符与 正则表达式对象（即`/pattern/`），但不使用 [`$regex`](https://www.mongodb.com/docs/upcoming/reference/operator/query/regex/#mongodb-query-op.-regex)运算符表达式。

#### 删除自己的游标

从MongoDB4.2开始，用户总是可以杀死自己的游标， 而不管用户是否具有特权 [`删除光标`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-killCursors)。因此，[`killCursors`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-killCursors) 特权在MongoDB 4.2中起不起作用。

在MongoDB 4.0中，用户需要[`killCursors`](https://www.mongodb.com/docs/upcoming/reference/privilege-actions/#mongodb-authaction-killCursors)权限 以杀死它们自己的光标。

#### 新参数

MongoDB 4.2添加了参数 [`replBatchLimitBytes`](https://www.mongodb.com/docs/upcoming/reference/parameters/#mongodb-parameter-param.replBatchLimitBytes)来配置最大操作日志应用程序批处理大小。从MongoDB 4.0.10开始，该参数也可用。

#### 对某些单文档向上插入的可重试写入

MongoDB 4.2将重试某些单文档upsert（upsert更新：真实和多重：false），其遇到重复键异常。有关条件，请参见 [Duplicate Key Errors on Upsert](https://www.mongodb.com/docs/upcoming/core/retryable-writes/#std-label-retryable-update-upsert)。

在MongoDB4.2之前，MongoDB不会重试upsert操作 遇到了重复键错误

#### `db.dropDatabase（）`和写入关注点

从MongODB 4.2开始，`mongo` shell方法 [`dropDatabase（）`](https://www.mongodb.com/docs/upcoming/reference/method/db.dropDatabase/#mongodb-method-db.dropDatabase)可以接受一个可选的写关注文档。

#### 丢弃连接

 [`dropConnections`](https://www.mongodb.com/docs/upcoming/reference/command/dropConnections/#mongodb-dbcommand-dbcmd.dropConnections)命令删除[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) / [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)实例到指定主机的传出连接。 [`dropConnections`](https://www.mongodb.com/docs/upcoming/reference/command/dropConnections/#mongodb-dbcommand-dbcmd.dropConnections)必须针对管理数据库运行。

#### 客户端断开连接

对于以下操作，如果在操作完成之前，发布客户端断开连接，MongoDB将以下操作标记为终止（例如，对操作执行[`killOp`](https://www.mongodb.com/docs/upcoming/reference/command/killOp/#mongodb-dbcommand-dbcmd.killOp)）：

| 命令                                                         | `mongo` shell方法                                            | 附注                                                         |
| ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| [`aggregate`](https://www.mongodb.com/docs/upcoming/reference/command/aggregate/#mongodb-dbcommand-dbcmd.aggregate) | [`db.collection.aggregate()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.aggregate/#mongodb-method-db.collection.aggregate) | 行为仅在管道不包括 [`$out`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/out/#mongodb-pipeline-pipe.-out) 以及 [`$merge`](https://www.mongodb.com/docs/upcoming/reference/operator/aggregation/merge/#mongodb-pipeline-pipe.-merge) |
| [`authenticate`](https://www.mongodb.com/docs/upcoming/reference/command/authenticate/#mongodb-dbcommand-dbcmd.authenticate) | [`db.auth()`](https://www.mongodb.com/docs/upcoming/reference/method/db.auth/#mongodb-method-db.auth) |                                                              |
| [`count`](https://www.mongodb.com/docs/upcoming/reference/command/count/#mongodb-dbcommand-dbcmd.count) | [`db.collection.count()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.count/#mongodb-method-db.collection.count)[`db.collection.countDocuments()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.countDocuments/#mongodb-method-db.collection.countDocuments)[`db.collection.estimatedDocumentCount()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.estimatedDocumentCount/#mongodb-method-db.collection.estimatedDocumentCount) |                                                              |
| [`distinct`](https://www.mongodb.com/docs/upcoming/reference/command/distinct/#mongodb-dbcommand-dbcmd.distinct) | [`db.collection.distinct()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.distinct/#mongodb-method-db.collection.distinct) |                                                              |
| [`find`](https://www.mongodb.com/docs/upcoming/reference/command/find/#mongodb-dbcommand-dbcmd.find) | [`db.collection.find()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.find/#mongodb-method-db.collection.find)[`db.collection.findOne()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.findOne/#mongodb-method-db.collection.findOne) |                                                              |
| [`getnonce`](https://www.mongodb.com/docs/upcoming/reference/command/getnonce/#mongodb-dbcommand-dbcmd.getnonce) |                                                              |                                                              |
| `isMaster`                                                   |                                                              |                                                              |
| [`listCollections`](https://www.mongodb.com/docs/upcoming/reference/command/listCollections/#mongodb-dbcommand-dbcmd.listCollections) | [`db.getCollectionInfos()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getCollectionInfos/#mongodb-method-db.getCollectionInfos)[`db.getCollectionNames()`](https://www.mongodb.com/docs/upcoming/reference/method/db.getCollectionNames/#mongodb-method-db.getCollectionNames) |                                                              |
| [`listDatabases`](https://www.mongodb.com/docs/upcoming/reference/command/listDatabases/#mongodb-dbcommand-dbcmd.listDatabases) |                                                              |                                                              |
| [`listIndexes`](https://www.mongodb.com/docs/upcoming/reference/command/listIndexes/#mongodb-dbcommand-dbcmd.listIndexes) | [`db.collection.getIndexes()`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.getIndexes/#mongodb-method-db.collection.getIndexes) |                                                              |

#### 启动警告

##### 内存中存储引擎

从版本4.2（以及4.0.13和3.6.14）开始，如果副本集成员使用[`内存中存储引擎`](https://www.mongodb.com/docs/upcoming/core/inmemory/#std-label-storage-inmemory)（表决或非表决），但副本集将[`writeConcernMajorityJournalDefault`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.writeConcernMajorityJournalDefault)（表决或非表决），但副本集将[`writeConcernMajorityJournalDefault`](https://www.mongodb.com/docs/upcoming/reference/replica-configuration/#mongodb-rsconf-rsconf.writeConcernMajorityJournalDefault)设置为true，则副本集成员将记录启动警告。

#### `mongo` Shell

从MongoDB 4.2（和4.0.13）开始，`mongo` shell显示一个 连接到非正版MongoDB实例时显示警告消息 这些实例的行为可能与官方MongoDB不同 实例;例如，缺失或不完整的特征、不同的特征 行为等等。

##### Map-Reduce

从4.2版本开始，MongoDB弃用：

- 也可以使用map-reduce选项*创建*新的分片集合 因为使用[分片](https://www.mongodb.com/docs/upcoming/reference/command/mapReduce/#std-label-mapreduce-out-cmd)选项 地图缩小。若要输出到分片集合，请创建分片 先收集。MongoDB 4.2还反对替换 现有的分片集合。
- 的显式规范[非原子：假](https://www.mongodb.com/docs/upcoming/reference/command/mapReduce/#std-label-mapreduce-out-cmd)选项卡页面上创建或编辑条目.

#### 回滚时间限制

从MongoDB 4.2开始，回滚时间限制计算为 公共点之后的第一个操作和 操作日志以使成员回滚。

在MongoDB 4.0中，回滚时间限制是在 公共点和操作日志中要滚动的成员的最后一个点 回来。

有关详细信息，请参阅[回滚运行时间限制。](https://www.mongodb.com/docs/upcoming/core/replica-set-rollbacks/#std-label-rollback-time-limit)

#### `isInteractive()`

MongoDB 4.2添加了一个新的`mongo` shell方法 `isInteractive（）`，它返回一个布尔值，指示 `mongo` shell正在以交互或脚本模式运行。

#### 变更以`解释`输出

从MongoDB 4.2开始，解释输出可以包含一个新的[`optimizedPipeline`](https://www.mongodb.com/docs/upcoming/reference/explain-results/#mongodb-data-explain.queryPlanner.optimizedPipeline)字段。有关详细信息，请参阅[`optimizedPipeline`](https://www.mongodb.com/docs/upcoming/reference/explain-results/#mongodb-data-explain.queryPlanner.optimizedPipeline)。

#### 更改为`isMaster`输出

从MongoDB 4.2开始，isMaster的输出和db.isMaster（）helper方法返回[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod) / [`mongos`](https://www.mongodb.com/docs/upcoming/reference/program/mongos/#mongodb-binary-bin.mongos)实例到客户机的连接的isMaster.connectionId。

### 优化的索引生成

针对已填充集合构建MongoDB索引需要针对该集合的独占读写锁。需要对集合进行读锁或写锁的操作必须等到[`mongod`](https://www.mongodb.com/docs/upcoming/reference/program/mongod/#mongodb-binary-bin.mongod)释放锁。MongoDB使用一个优化的构建过程，该过程只在索引构建的开始和结束时持有排它锁。构建过程的其余部分将交替执行读和写操作。

对于[功能兼容版本（FCV）](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv)`4. 2`， MongoDB4.2索引构建完全取代了索引构建过程 在以前的MongoDB版本中支持。MongoDB忽略 `后台`索引构建选项（如果指定为 [`创建索引`](https://www.mongodb.com/docs/upcoming/reference/command/createIndexes/#mongodb-dbcommand-dbcmd.createIndexes)或其外壳帮助程序 [`创建索引（）`](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndex/#mongodb-method-db.collection.createIndex)和 [`创建索引（）`。](https://www.mongodb.com/docs/upcoming/reference/method/db.collection.createIndexes/#mongodb-method-db.collection.createIndexes)

>需要功能兼容性版本4.2
>对于从4.0升级到4.2的MongoDB集群，您必须将[功能兼容版本（fcv）](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#std-label-view-fcv) 设置为4.2以启用优化的构建过程。有关设置fCV的详细信息，请参见[`setFeatureCompatibilityVersion`](https://www.mongodb.com/docs/upcoming/reference/command/setFeatureCompatibilityVersion/#mongodb-dbcommand-dbcmd.setFeatureCompatibilityVersion)。
>运行fCV 4.0的MongoDB 4.2集群仅支持4.0索引构建。

有关索引生成过程的完整文档，请参见[Index Builds on Populated Collections.](https://www.mongodb.com/docs/upcoming/core/index-creation/#std-label-index-operations)

### 影响兼容性的变更

某些更改可能会影响兼容性，并且可能需要用户操作。为 兼容性更改的详细列表，请参见 [MongoDB 4.2中的兼容性更改。](https://www.mongodb.com/docs/upcoming/release-notes/4.2-compatibility/)

### 升级程序



>###### 功能兼容性版本
>
>要升级，4.0实例必须具有 `功能兼容性版本`设置为`4.0`。要检查版本：
>
>```shell
>db.adminCommand( { getParameter: 1, featureCompatibilityVersion: 1 } )
>```
>
>关验证和设置 `功能兼容性版本`以及有关其他 升级的先决条件/注意事项，请参阅 升级说明：
>
>- [将单机版升级到4.2](https://www.mongodb.com/docs/upcoming/release-notes/4.2-upgrade-standalone/)
>- [将副本集升级到4.2](https://www.mongodb.com/docs/upcoming/release-notes/4.2-upgrade-replica-set/)
>- [将分片群集升级到4.2](https://www.mongodb.com/docs/upcoming/release-notes/4.2-upgrade-sharded-cluster/)

如果您需要升级到4.2的指导，[MongoDB专业服务](https://www.mongodb.com/products/consulting?tck=docs_server)提供 主要版本升级支持，以帮助确保平稳过渡 而不会中断MongoDB应用程序。

### 下载

要下载MongoDB4.2，请访问[MongoDB下载中心](https://www.mongodb.com/download-center/community?tck=docs_server)

### 已知问题

| 版本中 | 问题                                                         | 现况          |
| ------ | ------------------------------------------------------------ | ------------- |
| 4.2.0  | [SERVER-43075](https://jira.mongodb.org/browse/SERVER-43075)：缺失 [`storage.journal.commitIntervalMs`](https://www.mongodb.com/docs/upcoming/reference/configuration-options/#mongodb-setting-storage.journal.commitIntervalMs) | 在4.2.1中修复 |

### 报告问题

要报告问题，请参阅 https://github.com/mongodb/mongo/wiki/Submit-Bug-Reports为 关于如何为MongoDB服务器提交JIRA票证的说明 有关项目的资料。





 译者：韩鹏帅
 参见

原文 - [Release Notes for MongoDB 4.2]( https://docs.mongodb.com/manual/release-notes/4.2/ )

